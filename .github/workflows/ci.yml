name: CI
on: [push]
jobs:
  lhci:
    name: Lighthouse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Resolve published product handle
        id: resolve_product
        shell: bash
        env:
          SHOP_STORE_OS2: ${{ secrets.SHOP_STORE_OS2 }}
          SHOP_ACCESS_TOKEN: ${{ secrets.SHOP_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          if ! command -v jq >/dev/null 2>&1; then
            echo "::error::jq is required on the runner to parse Shopify Admin API response."
            exit 1
          fi

          shop_domain="${SHOP_STORE_OS2}"
          if [[ "${shop_domain}" != *.myshopify.com ]]; then
            shop_domain="${shop_domain}.myshopify.com"
          fi

          api_url="https://${shop_domain}/admin/api/2025-10/products.json?status=active&published_status=published&fields=handle&limit=1"
          response_file="$(mktemp)"
          http_status="$(
            curl -sS \
              -o "${response_file}" \
              -w "%{http_code}" \
              -H "X-Shopify-Access-Token: ${SHOP_ACCESS_TOKEN}" \
              "${api_url}"
          )"

          if [[ "${http_status}" -lt 200 || "${http_status}" -ge 300 ]]; then
            echo "::error::Failed to fetch products from Shopify Admin API (HTTP ${http_status})."
            cat "${response_file}"
            exit 1
          fi

          product_handle="$(jq -r '.products[0].handle // empty' "${response_file}")"
          if [[ -z "${product_handle}" ]]; then
            echo "::error::No active and published product found for Online Store. LHCI product audit cannot run."
            cat "${response_file}"
            exit 1
          fi

          echo "Using product handle: ${product_handle}"
          echo "product_handle=${product_handle}" >> "${GITHUB_OUTPUT}"

      - name: Lighthouse
        uses: shopify/lighthouse-ci-action@v1
        with:
          store: ${{ secrets.SHOP_STORE_OS2 }}
          password: ${{ secrets.SHOP_PASSWORD_OS2 }}
          access_token: ${{ secrets.SHOP_ACCESS_TOKEN }}
          product_handle: ${{ steps.resolve_product.outputs.product_handle }}
          collection_handle: all
          lhci_github_app_token: ${{ secrets.LHCI_GITHUB_TOKEN }}
          lhci_min_score_accessibility: 0.89
  theme-check:
    name: Theme Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Theme Check
        uses: shopify/theme-check-action@v2
        with:
          token: ${{ github.token }}
