<header
  class="fixed top-0 left-0 right-0 z-50 bg-brand-bg/95 backdrop-blur-sm shadow-sm py-4"
  data-lusena-header
>
  {% stylesheet %}
    .lusena-header__nav {
      display: none;
    }

    .lusena-header__desktop-only {
      display: none;
    }

    [data-lusena-mobile-menu-wrapper] {
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      transition: grid-template-rows 260ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 160ms ease;
    }

    [data-lusena-mobile-menu-inner] {
      overflow: hidden;
      background-color: inherit;
    }

    [data-lusena-header].lusena-header--menu-open [data-lusena-mobile-menu-wrapper] {
      grid-template-rows: 1fr;
      opacity: 1;
    }

    [data-lusena-mobile-menu-content] {
      opacity: 0;
      transform: translateY(-0.5rem);
      transition: opacity 160ms ease, transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1);
      will-change: transform, opacity;
    }

    [data-lusena-header].lusena-header--menu-open [data-lusena-mobile-menu-content] {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      [data-lusena-mobile-menu-wrapper] {
        transition: none;
      }
      [data-lusena-mobile-menu-content] {
        transition: none;
        transform: none;
      }
    }

    @media (min-width: 1024px) {
      .lusena-header__nav {
        display: flex;
      }

      .lusena-header__desktop-only {
        display: flex;
      }
    }
  {% endstylesheet %}

  {%- liquid
    assign about_url = section.settings.about_page.url
    if about_url == blank
      assign about_url = '/pages/o-nas'
    endif

    assign silk_url = section.settings.silk_page.url
    if silk_url == blank
      assign silk_url = '/pages/nasza-jakosc'
    endif

    assign sklep_url = routes.all_products_collection_url
    assign primary_urls = sklep_url | append: '||' | append: about_url | append: '||' | append: silk_url | split: '||'
  -%}

  <div class="container flex items-center justify-between">
    <details class="lg:hidden relative" data-lusena-mobile-menu-details>
      <summary class="list-none p-2 cursor-pointer" aria-label="Menu" aria-controls="lusena-mobile-menu-panel">
        {% render 'lusena-icon', name: 'menu', class: 'w-6 h-6 text-primary', stroke_width: 1.5 %}
      </summary>
    </details>

    <a
      href="{{ routes.root_url }}"
      class="flex items-center cursor-pointer"
      aria-label="{{ shop.name | escape }}"
      style="color: {{ section.settings.logo_color }};"
    >
      {%- if section.settings.logo_svg_inline != blank -%}
        <span style="display: inline-flex; line-height: 0; width: {{ section.settings.logo_width }}px;">
          {{ section.settings.logo_svg_inline }}
        </span>
      {%- elsif section.settings.logo_image != blank -%}
        {{
          section.settings.logo_image
          | image_url: width: section.settings.logo_width
          | image_tag: alt: shop.name, loading: 'eager', class: 'h-auto w-auto'
        }}
      {%- else -%}
        <span class="text-2xl font-serif tracking-tight font-medium">
          {{ section.settings.logo_text_fallback | default: shop.name | escape }}
        </span>
      {%- endif -%}
    </a>

    <nav class="lusena-header__nav items-center gap-8">
      <a href="{{ sklep_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">SKLEP</a>
      <a href="{{ about_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">O NAS</a>
      <a href="{{ silk_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">DLACZEGO JEDWAB?</a>

      {%- if section.settings.show_additional_menu and section.settings.menu != blank -%}
        {%- for link in section.settings.menu.links -%}
          {%- unless primary_urls contains link.url -%}
            <a href="{{ link.url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">
              {{ link.title | escape }}
            </a>
          {%- endunless -%}
        {%- endfor -%}
      {%- endif -%}
    </nav>

    <div class="flex items-center gap-2 md:gap-4">
      {%- if section.settings.enable_search -%}
        <a href="{{ routes.search_url }}" class="lusena-header__desktop-only h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Search">
          {% render 'lusena-icon', name: 'search', class: 'w-5 h-5 text-primary', stroke_width: 1.5 %}
        </a>
      {%- endif -%}

      {%- if section.settings.enable_account and shop.customer_accounts_enabled -%}
        <a href="{{ routes.account_url }}" class="lusena-header__desktop-only h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Account">
          {% render 'lusena-icon', name: 'user', class: 'w-5 h-5 text-primary', stroke_width: 2 %}
        </a>
      {%- endif -%}

      {%- if section.settings.enable_cart -%}
        <a href="{{ routes.cart_url }}" id="cart-icon-bubble" class="relative flex h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Cart">
          {% render 'lusena-icon', name: 'shopping-bag', class: 'w-5 h-5 text-primary', stroke_width: 2 %}
          {%- if cart.item_count > 0 -%}
            <span class="absolute -top-1 -right-1 bg-accent-cta text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full border border-white">
              {{ cart.item_count }}
            </span>
          {%- endif -%}
        </a>
      {%- endif -%}
    </div>
  </div>

  <div class="lg:hidden" id="lusena-mobile-menu-panel" data-lusena-mobile-menu-wrapper aria-hidden="true">
    <div data-lusena-mobile-menu-inner>
      <div class="container pb-4" data-lusena-mobile-menu-content>
        <nav class="flex flex-col gap-4">
          <a href="{{ sklep_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">SKLEP</a>
          <a href="{{ about_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors whitespace-nowrap">O NAS</a>
          <a href="{{ silk_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">DLACZEGO JEDWAB?</a>

          {%- if section.settings.show_additional_menu and section.settings.menu != blank -%}
            {%- for link in section.settings.menu.links -%}
              {%- unless primary_urls contains link.url -%}
                <a href="{{ link.url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">
                  {{ link.title | escape }}
                </a>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}
        </nav>
      </div>
    </div>
  </div>
</header>

  {% javascript %}
  (() => {
    const header = document.querySelector('[data-lusena-header]');
    if (!header) return;

    const scrolledClasses = ['bg-brand-bg/95', 'backdrop-blur-sm', 'shadow-sm', 'py-4'];
    const topClasses = ['bg-transparent', 'py-6'];

    const mobileMenuDetails = header.querySelector('[data-lusena-mobile-menu-details]');
    const mobileMenuPanel = header.querySelector('[data-lusena-mobile-menu-wrapper]');

    const setPanelA11y = () => {
      if (!mobileMenuDetails || !mobileMenuPanel) return;
      const shouldBeAccessible =
        mobileMenuDetails.open && !mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing');
      mobileMenuPanel.inert = !shouldBeAccessible;
      mobileMenuPanel.setAttribute('aria-hidden', shouldBeAccessible ? 'false' : 'true');
    };

    const update = () => {
      const isMenuVisible =
        !!mobileMenuDetails?.open || mobileMenuDetails?.hasAttribute('data-lusena-mobile-menu-closing');

      header.classList.add(...scrolledClasses);
      header.classList.remove(...topClasses);

      if (isMenuVisible) return;
    };

    update();
    window.addEventListener('scroll', update, { passive: true });

    if (mobileMenuDetails) {
      const summary = mobileMenuDetails.querySelector('summary');
      if (summary) {
        summary.addEventListener('click', (event) => {
          if (!mobileMenuDetails.open) return;
          if (mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')) return;
          event.preventDefault();

          mobileMenuDetails.setAttribute('data-lusena-mobile-menu-closing', 'true');
          header.classList.remove('lusena-header--menu-open');
          setPanelA11y();
          update();

          window.setTimeout(() => {
            mobileMenuDetails.removeAttribute('open');
            mobileMenuDetails.removeAttribute('data-lusena-mobile-menu-closing');
            setPanelA11y();
            update();
          }, 280);
        });
      }

      mobileMenuDetails.addEventListener('toggle', () => {
        header.classList.toggle(
          'lusena-header--menu-open',
          mobileMenuDetails.open && !mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')
        );
        setPanelA11y();
        update();
      });
    }

    if (window.Shopify?.designMode) {
      document.addEventListener('shopify:section:load', update);
    }
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA header (draft)",
  "tag": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo image"
    },
    {
      "type": "liquid",
      "id": "logo_svg_inline",
      "label": "Logo SVG (inline)",
      "info": "Optional. Paste SVG markup here to enable dynamic coloring via the Logo color setting. Use fill=\"currentColor\" in the SVG for best results."
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "Logo width",
      "min": 60,
      "max": 260,
      "step": 2,
      "unit": "px",
      "default": 140
    },
    {
      "type": "color",
      "id": "logo_color",
      "label": "Logo color",
      "default": "#111111"
    },
    {
      "type": "text",
      "id": "logo_text_fallback",
      "label": "Logo text (fallback)",
      "default": "LUSENA"
    },
    {
      "type": "page",
      "id": "about_page",
      "label": "O NAS page"
    },
    {
      "type": "page",
      "id": "silk_page",
      "label": "DLACZEGO JEDWAB? page"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Additional menu (optional)",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "show_additional_menu",
      "label": "Show additional menu links in header",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_search",
      "label": "Show search icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_account",
      "label": "Show account icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_cart",
      "label": "Show cart icon",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "LUSENA header (draft)"
    }
  ]
}
{% endschema %}
