<header
  class="fixed top-0 left-0 right-0 z-50 bg-brand-bg/95 backdrop-blur-sm shadow-sm py-4"
  data-lusena-header{% if section.settings.auto_hide_on_scroll_mobile %} data-lusena-auto-hide-on-scroll-mobile{% endif %}{% if section.settings.auto_hide_on_scroll_desktop %} data-lusena-auto-hide-on-scroll-desktop{% endif %}
>
  {% stylesheet %}
    .lusena-header__nav {
      display: none;
    }

    @media (max-width: 767px) {
      [data-lusena-header] {
        transition: transform 220ms ease;
        will-change: transform;
      }

      [data-lusena-header].lusena-header--auto-hidden {
        transform: translateY(-110%);
      }

      [data-lusena-header].lusena-header--menu-open {
        transform: translateY(0);
      }
    }

    @media (min-width: 1024px) {
      [data-lusena-header] {
        transition: transform 220ms ease;
        will-change: transform;
      }

      [data-lusena-header].lusena-header--auto-hidden {
        transform: translateY(-110%);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      [data-lusena-header] {
        transition: none;
      }
    }

    .lusena-header__desktop-only {
      display: none;
    }

    .lusena-header__cart-count {
      position: absolute;
      top: -0.3rem;
      right: -0.3rem;
      width: 1.8rem;
      height: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: 2px solid rgb(255 255 255);
      background-color: rgb(14 94 90);
      color: rgb(255 255 255);
      font-size: 10px;
      line-height: 1;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      text-indent: 0.04em;
    }

    [data-lusena-mobile-menu-wrapper] {
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      transition: grid-template-rows 260ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 160ms ease;
    }

    [data-lusena-mobile-menu-inner] {
      overflow: hidden;
      background-color: inherit;
    }

    [data-lusena-header].lusena-header--menu-open [data-lusena-mobile-menu-wrapper] {
      grid-template-rows: 1fr;
      opacity: 1;
    }

    [data-lusena-mobile-menu-content] {
      opacity: 0;
      transform: translateY(-0.5rem);
      transition: opacity 160ms ease, transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1);
      will-change: transform, opacity;
    }

    [data-lusena-header].lusena-header--menu-open [data-lusena-mobile-menu-content] {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      [data-lusena-mobile-menu-wrapper] {
        transition: none;
      }
      [data-lusena-mobile-menu-content] {
        transition: none;
        transform: none;
      }
    }

    @media (min-width: 1024px) {
      .lusena-header__nav {
        display: flex;
      }

      .lusena-header__desktop-only {
        display: flex;
      }
    }
  {% endstylesheet %}

  {%- liquid
    assign about_url = section.settings.about_page.url
    if about_url == blank
      assign about_url = '/pages/o-nas'
    endif

    assign silk_url = section.settings.silk_page.url
    if silk_url == blank
      assign silk_url = '/pages/nasza-jakosc'
    endif

    assign sklep_url = routes.all_products_collection_url
    assign primary_urls = sklep_url | append: '||' | append: about_url | append: '||' | append: silk_url | split: '||'
  -%}

  <div class="container flex items-center justify-between" data-lusena-header-bar>
    <details class="lg:hidden relative" data-lusena-mobile-menu-details>
      <summary class="list-none p-2 cursor-pointer" aria-label="Menu" aria-controls="lusena-mobile-menu-panel">
        {% render 'lusena-icon', name: 'menu', class: 'w-6 h-6 text-primary', stroke_width: 1.5 %}
      </summary>
    </details>

    <a
      href="{{ routes.root_url }}"
      class="flex items-center cursor-pointer"
      aria-label="{{ shop.name | escape }}"
      style="color: {{ section.settings.logo_color }};"
    >
      {%- if section.settings.logo_svg_inline != blank -%}
        <span style="display: inline-flex; line-height: 0; width: {{ section.settings.logo_width }}px;">
          {{ section.settings.logo_svg_inline }}
        </span>
      {%- elsif section.settings.logo_image != blank -%}
        {{
          section.settings.logo_image
          | image_url: width: section.settings.logo_width
          | image_tag: alt: shop.name, loading: 'eager', class: 'h-auto w-auto'
        }}
      {%- else -%}
        <span class="text-2xl font-serif tracking-tight font-medium">
          {{ section.settings.logo_text_fallback | default: shop.name | escape }}
        </span>
      {%- endif -%}
    </a>

    <nav class="lusena-header__nav items-center gap-8">
      <a href="{{ sklep_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">SKLEP</a>
      <a href="{{ about_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">O NAS</a>
      <a href="{{ silk_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">DLACZEGO JEDWAB?</a>

      {%- if section.settings.show_additional_menu and section.settings.menu != blank -%}
        {%- for link in section.settings.menu.links -%}
          {%- unless primary_urls contains link.url -%}
            <a href="{{ link.url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">
              {{ link.title | escape }}
            </a>
          {%- endunless -%}
        {%- endfor -%}
      {%- endif -%}
    </nav>

    <div class="flex items-center gap-2 md:gap-4">
      {%- if section.settings.enable_search -%}
        <a href="{{ routes.search_url }}" class="lusena-header__desktop-only h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Search">
          {% render 'lusena-icon', name: 'search', class: 'w-5 h-5 text-primary', stroke_width: 1.5 %}
        </a>
      {%- endif -%}

      {%- if section.settings.enable_account and shop.customer_accounts_enabled -%}
        <a href="{{ routes.account_url }}" class="lusena-header__desktop-only h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Account">
          {% render 'lusena-icon', name: 'user', class: 'w-5 h-5 text-primary', stroke_width: 2 %}
        </a>
      {%- endif -%}

      {%- if section.settings.enable_cart -%}
        <a href="{{ routes.cart_url }}" id="cart-icon-bubble" class="relative flex h-11 w-11 items-center justify-center hover:bg-surface-2 text-primary transition-colors" aria-label="Cart">
          {% render 'lusena-icon', name: 'shopping-bag', class: 'w-5 h-5 text-primary', stroke_width: 2 %}
          {%- if cart.item_count > 0 -%}
            <span class="lusena-header__cart-count">
              {{- cart.item_count -}}
            </span>
          {%- endif -%}
        </a>
      {%- endif -%}
    </div>
  </div>

  <div class="lg:hidden" id="lusena-mobile-menu-panel" data-lusena-mobile-menu-wrapper aria-hidden="true">
    <div data-lusena-mobile-menu-inner>
      <div class="container py-4" data-lusena-mobile-menu-content>
        <nav class="flex flex-col gap-4">
          <a href="{{ sklep_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">SKLEP</a>
          <a href="{{ about_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors whitespace-nowrap">O NAS</a>
          <a href="{{ silk_url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">DLACZEGO JEDWAB?</a>

          {%- if section.settings.show_additional_menu and section.settings.menu != blank -%}
            {%- for link in section.settings.menu.links -%}
              {%- unless primary_urls contains link.url -%}
                <a href="{{ link.url }}" class="text-sm font-medium hover:text-accent-cta transition-colors">
                  {{ link.title | escape }}
                </a>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}
        </nav>
      </div>
    </div>
  </div>
</header>

  {% javascript %}
  (() => {
    const header = document.querySelector('[data-lusena-header]');
    if (!header) return;
    if (header.hasAttribute('data-lusena-autohide-init')) return;
    header.setAttribute('data-lusena-autohide-init', 'true');

    const headerBar = header.querySelector('[data-lusena-header-bar]');
    const readPx = (value) => {
      const parsed = Number.parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    };

    const syncHeaderHeightCssVar = () => {
      const headerStyles = getComputedStyle(header);
      const paddingTop = readPx(headerStyles.paddingTop);
      const paddingBottom = readPx(headerStyles.paddingBottom);
      const barRect = (headerBar || header).getBoundingClientRect();
      const height = Math.ceil(barRect.height + paddingTop + paddingBottom);

      document.documentElement.style.setProperty('--lusena-header-height', `${height}px`);
      document.documentElement.style.setProperty('--header-height', `${height}px`);
    };

    syncHeaderHeightCssVar();

    if (window.ResizeObserver) {
      const ro = new ResizeObserver(() => {
        syncHeaderHeightCssVar();
      });
      ro.observe(headerBar || header);
    }
    window.addEventListener('resize', syncHeaderHeightCssVar, { passive: true });

    const autoHideOnScrollMobile = header.hasAttribute('data-lusena-auto-hide-on-scroll-mobile');
    const autoHideMobileMq = window.matchMedia('(max-width: 767px)');
    const autoHideOnScrollDesktop = header.hasAttribute('data-lusena-auto-hide-on-scroll-desktop');
    const autoHideDesktopMq = window.matchMedia('(min-width: 1024px)');
    const autoHideDeltaThresholdPx = 8;
    const autoHideTopThresholdPx = 24;

    let lastScrollY = window.scrollY;

    const scrolledClasses = ['bg-brand-bg/95', 'backdrop-blur-sm', 'shadow-sm', 'py-4'];
    const topClasses = ['bg-transparent', 'py-6'];

    const mobileMenuDetails = header.querySelector('[data-lusena-mobile-menu-details]');
    const mobileMenuPanel = header.querySelector('[data-lusena-mobile-menu-wrapper]');

    const closeMobileMenu = () => {
      if (!mobileMenuDetails?.open) return;
      if (mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')) return;

      mobileMenuDetails.setAttribute('data-lusena-mobile-menu-closing', 'true');
      header.classList.remove('lusena-header--menu-open');
      setPanelA11y();
      update();

      window.setTimeout(() => {
        mobileMenuDetails.removeAttribute('open');
        mobileMenuDetails.removeAttribute('data-lusena-mobile-menu-closing');
        setPanelA11y();
        update();
      }, 280);
    };

    const setPanelA11y = () => {
      if (!mobileMenuDetails || !mobileMenuPanel) return;
      const shouldBeAccessible =
        mobileMenuDetails.open && !mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing');
      mobileMenuPanel.inert = !shouldBeAccessible;
      mobileMenuPanel.setAttribute('aria-hidden', shouldBeAccessible ? 'false' : 'true');
    };

    const update = () => {
      const isMenuVisible =
        !!mobileMenuDetails?.open || mobileMenuDetails?.hasAttribute('data-lusena-mobile-menu-closing');

      header.classList.add(...scrolledClasses);
      header.classList.remove(...topClasses);

      const shouldAutoHide =
        (autoHideOnScrollMobile && autoHideMobileMq.matches) ||
        (autoHideOnScrollDesktop && autoHideDesktopMq.matches);

      if (!shouldAutoHide) {
        header.classList.remove('lusena-header--auto-hidden');
        lastScrollY = window.scrollY;
        return;
      }

      if (isMenuVisible) {
        header.classList.remove('lusena-header--auto-hidden');
        lastScrollY = window.scrollY;
        return;
      }

      const nextScrollY = window.scrollY;
      const delta = nextScrollY - lastScrollY;

      if (Math.abs(delta) < autoHideDeltaThresholdPx) return;

      if (nextScrollY < autoHideTopThresholdPx) {
        header.classList.remove('lusena-header--auto-hidden');
        lastScrollY = nextScrollY;
        return;
      }

      header.classList.toggle('lusena-header--auto-hidden', delta > 0);
      lastScrollY = nextScrollY;
    };

    update();
    window.addEventListener('scroll', update, { passive: true });
    header.addEventListener('focusin', update);

    if (autoHideMobileMq.addEventListener) {
      autoHideMobileMq.addEventListener('change', () => {
        header.classList.remove('lusena-header--auto-hidden');
        lastScrollY = window.scrollY;
      });
    }
    if (autoHideDesktopMq.addEventListener) {
      autoHideDesktopMq.addEventListener('change', () => {
        header.classList.remove('lusena-header--auto-hidden');
        lastScrollY = window.scrollY;
      });
    }

    if (mobileMenuDetails) {
      const summary = mobileMenuDetails.querySelector('summary');
      if (summary) {
        summary.addEventListener('click', (event) => {
          if (!mobileMenuDetails.open) return;
          if (mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')) return;
          event.preventDefault();
          closeMobileMenu();
        });
      }

      mobileMenuDetails.addEventListener('toggle', () => {
        header.classList.toggle(
          'lusena-header--menu-open',
          mobileMenuDetails.open && !mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')
        );
        setPanelA11y();
        update();
      });
    }

    document.addEventListener(
      'pointerdown',
      (event) => {
        if (!mobileMenuDetails?.open) return;
        if (mobileMenuDetails.hasAttribute('data-lusena-mobile-menu-closing')) return;
        if (mobileMenuPanel?.contains(event.target)) return;
        if (mobileMenuDetails?.querySelector('summary')?.contains(event.target)) return;
        closeMobileMenu();
      },
      { capture: true }
    );

    if (window.Shopify?.designMode) {
      document.addEventListener('shopify:section:load', () => {
        syncHeaderHeightCssVar();
        update();
      });
    }
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA header (draft)",
  "tag": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo image"
    },
    {
      "type": "liquid",
      "id": "logo_svg_inline",
      "label": "Logo SVG (inline)",
      "info": "Optional. Paste SVG markup here to enable dynamic coloring via the Logo color setting. Use fill=\"currentColor\" in the SVG for best results."
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "Logo width",
      "min": 60,
      "max": 260,
      "step": 2,
      "unit": "px",
      "default": 140
    },
    {
      "type": "color",
      "id": "logo_color",
      "label": "Logo color",
      "default": "#111111"
    },
    {
      "type": "text",
      "id": "logo_text_fallback",
      "label": "Logo text (fallback)",
      "default": "LUSENA"
    },
    {
      "type": "page",
      "id": "about_page",
      "label": "O NAS page"
    },
    {
      "type": "page",
      "id": "silk_page",
      "label": "DLACZEGO JEDWAB? page"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Additional menu (optional)",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "show_additional_menu",
      "label": "Show additional menu links in header",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_search",
      "label": "Show search icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_account",
      "label": "Show account icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_cart",
      "label": "Show cart icon",
      "default": true
    },
    {
      "type": "header",
      "content": "Mobile behavior"
    },
    {
      "type": "checkbox",
      "id": "auto_hide_on_scroll_mobile",
      "label": "Auto-hide header on scroll (mobile)",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "auto_hide_on_scroll_desktop",
      "label": "Auto-hide header on scroll (desktop)",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "LUSENA header (draft)"
    }
  ]
}
{% endschema %}
