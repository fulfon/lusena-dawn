{%- liquid
  assign has_evidence_blocks = false
  for block in section.blocks
    if block.type == 'evidence'
      assign has_evidence_blocks = true
      break
    endif
  endfor
-%}

{%- if has_evidence_blocks -%}
  <section
    class="lusena-pdp-quality-evidence"
    data-lusena-quality-evidence
    style="
      --lusena-section-padding-top-mobile: {{ section.settings.padding_top_mobile }}px;
      --lusena-section-padding-bottom-mobile: {{ section.settings.padding_bottom_mobile }}px;
      --lusena-section-padding-top-desktop: {{ section.settings.padding_top }}px;
      --lusena-section-padding-bottom-desktop: {{ section.settings.padding_bottom }}px;
    "
  >
    <div class="container">
      <h2 class="lusena-pdp-quality-evidence__heading{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
        {{ section.settings.heading | escape }}
      </h2>

      <div class="lusena-pdp-quality-evidence__stack"{% if settings.animations_reveal_on_scroll %} data-cascade{% endif %}>
        {%- for block in section.blocks -%}
          {%- if block.type == 'evidence' -%}
            {%- liquid
              assign cta_url = block.settings.cta_link
              assign cta_opens_new_tab = false

              if block.settings.use_certificate_link
                assign certificate_url = blank

                if shop.metafields.lusena.oeko_tex_certificate != blank
                  assign certificate_file = shop.metafields.lusena.oeko_tex_certificate.value
                  if certificate_file != blank
                    if certificate_file.url != blank
                      assign certificate_url = certificate_file.url
                      assign cta_opens_new_tab = true
                    endif
                  endif
                endif

                if certificate_url != blank
                  assign cta_url = certificate_url
                else
                  assign cta_url = '/pages/nasza-jakosc'
                endif
              endif
            -%}

            <div class="lusena-pdp-quality-evidence__item{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}" data-lusena-quality-evidence-item {{ block.shopify_attributes }}>
              <button
                type="button"
                class="lusena-pdp-quality-evidence__toggle focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-cta focus-visible:ring-offset-2"
                data-lusena-quality-evidence-toggle
                aria-expanded="false"
              >
                <span class="lusena-pdp-quality-evidence__toggle-icon-wrap">
                  {% render 'lusena-icon', name: block.settings.icon, class: 'lusena-pdp-quality-evidence__toggle-icon', stroke_width: 1.5 %}
                </span>
                <span class="lusena-pdp-quality-evidence__toggle-copy">
                  <span class="lusena-pdp-quality-evidence__title">{{ block.settings.title | escape }}</span>
                  <span class="lusena-pdp-quality-evidence__summary">{{ block.settings.summary | escape | newline_to_br }}</span>
                </span>
                {% render 'lusena-icon', name: 'chevron-down', class: 'lusena-pdp-quality-evidence__chevron', stroke_width: 1.5 %}
              </button>

              <div class="lusena-pdp-quality-evidence__panel" data-lusena-quality-evidence-panel>
                <div class="lusena-pdp-quality-evidence__panel-inner">
                  {%- if block.settings.detail != blank -%}
                    <p class="lusena-pdp-quality-evidence__detail">
                      {{ block.settings.detail | escape | newline_to_br }}
                    </p>
                  {%- endif -%}

                  {%- if block.settings.cta_label != blank -%}
                    {%- if cta_url != blank -%}
                      <a
                        href="{{ cta_url }}"
                        class="lusena-pdp-quality-evidence__cta"
                        {% if cta_opens_new_tab %}
                          target="_blank" rel="noopener"
                        {% endif %}
                      >
                        {{ block.settings.cta_label | escape }}
                      </a>
                    {%- else -%}
                      <span class="lusena-pdp-quality-evidence__cta">
                        {{ block.settings.cta_label | escape }}
                      </span>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </section>
{%- endif -%}

{% stylesheet %}
  .lusena-pdp-quality-evidence {
    padding-top: var(--lusena-section-padding-top-mobile);
    padding-bottom: var(--lusena-section-padding-bottom-mobile);
    background-color: rgb(247 245 242 / 1);
  }

  .lusena-pdp-quality-evidence__heading {
    margin: 0 0 48px;
    font-family: 'Source Serif 4', serif;
    font-size: 24px;
    line-height: 32px;
    color: rgb(17 17 17 / 1);
    text-align: center;
  }

  .lusena-pdp-quality-evidence__stack {
    max-width: 768px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .lusena-pdp-quality-evidence__item {
    background-color: rgb(240 238 235 / 1);
    border-radius: 2px;
    overflow: hidden;
  }

  .lusena-pdp-quality-evidence__toggle {
    width: 100%;
    padding: 20px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    text-align: left;
    background-color: rgb(240 238 235 / 1);
    border: 0;
    transition: background-color 0.15s ease;
    color: inherit;
  }

  .lusena-pdp-quality-evidence__toggle:hover {
    background-color: rgb(240 238 235 / 0.8);
  }

  .lusena-pdp-quality-evidence__toggle-icon-wrap {
    width: 40px;
    height: 40px;
    border-radius: 9999px;
    background-color: rgb(247 245 242 / 1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .lusena-pdp-quality-evidence__toggle-icon {
    width: 20px;
    height: 20px;
    color: rgb(14 94 90 / 1);
  }

  .lusena-pdp-quality-evidence__toggle-copy {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .lusena-pdp-quality-evidence__title {
    margin: 0;
    font-family: 'Source Serif 4', serif;
    font-size: 20px;
    line-height: 28px;
    color: rgb(17 17 17 / 1);
  }

  .lusena-pdp-quality-evidence__summary {
    margin: 0;
    font-size: 14px;
    line-height: 1.625;
    color: rgb(74 74 74 / 1);
  }

  .lusena-pdp-quality-evidence__chevron {
    width: 20px;
    height: 20px;
    color: rgb(74 74 74 / 0.5);
    flex-shrink: 0;
    margin-top: 4px;
    transition: transform 0.2s ease;
  }

  .lusena-pdp-quality-evidence__panel {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
  }

  .lusena-pdp-quality-evidence__panel-inner {
    padding: 0 20px 20px 72px;
  }

  .lusena-pdp-quality-evidence__detail {
    margin: 0 0 12px;
    font-size: 14px;
    line-height: 1.625;
    color: rgb(74 74 74 / 1);
  }

  .lusena-pdp-quality-evidence__cta {
    font-size: 12px;
    line-height: 16px;
    font-weight: 500;
    color: rgb(14 94 90 / 1);
    text-decoration: none;
  }

  .lusena-pdp-quality-evidence__cta:hover {
    text-decoration: underline;
  }

  .lusena-pdp-quality-evidence__cta:focus-visible {
    outline: 2px solid rgb(14 94 90);
    outline-offset: 2px;
  }

  .lusena-pdp-quality-evidence__item.is-open .lusena-pdp-quality-evidence__chevron {
    transform: rotate(180deg);
  }

  .lusena-pdp-quality-evidence__item.is-open .lusena-pdp-quality-evidence__panel {
    max-height: 500px;
    opacity: 1;
  }

  @media (min-width: 768px) {
    .lusena-pdp-quality-evidence {
      padding-top: var(--lusena-section-padding-top-desktop);
      padding-bottom: var(--lusena-section-padding-bottom-desktop);
    }

    .lusena-pdp-quality-evidence__heading {
      font-size: 28px;
      line-height: 36px;
    }

    .lusena-pdp-quality-evidence__toggle {
      padding: 24px;
    }

    .lusena-pdp-quality-evidence__panel-inner {
      padding: 0 24px 24px 72px;
    }
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const initRoot = (root) => {
      if (!root) return;
      if (root.hasAttribute('data-lusena-quality-evidence-init')) return;

      root.setAttribute('data-lusena-quality-evidence-init', 'true');
      const items = Array.from(root.querySelectorAll('[data-lusena-quality-evidence-item]'));

      const setExpanded = (item, expanded) => {
        const toggle = item.querySelector('[data-lusena-quality-evidence-toggle]');
        if (!toggle) return;
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      };

      const closeItem = (item) => {
        item.classList.remove('is-open');
        setExpanded(item, false);
      };

      const openItem = (item) => {
        items.forEach((otherItem) => {
          if (otherItem !== item) {
            closeItem(otherItem);
          }
        });
        item.classList.add('is-open');
        setExpanded(item, true);
      };

      items.forEach((item) => {
        const toggle = item.querySelector('[data-lusena-quality-evidence-toggle]');
        if (!toggle) return;

        toggle.addEventListener('click', () => {
          if (item.classList.contains('is-open')) {
            closeItem(item);
            return;
          }
          openItem(item);
        });
      });
    };

    const initAll = (scope) => {
      const searchRoot = scope || document;
      const roots = searchRoot.querySelectorAll('[data-lusena-quality-evidence]');
      roots.forEach((root) => initRoot(root));
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initAll(document));
    } else {
      initAll(document);
    }

    if (window.Shopify && window.Shopify.designMode) {
      document.addEventListener('shopify:section:load', (event) => {
        initAll(event.target);
      });

      document.addEventListener('shopify:block:select', (event) => {
        const selectedItem = event.target.closest('[data-lusena-quality-evidence-item]');
        if (!selectedItem) return;

        const root = selectedItem.closest('[data-lusena-quality-evidence]');
        if (!root) return;

        const items = Array.from(root.querySelectorAll('[data-lusena-quality-evidence-item]'));
        items.forEach((item) => {
          const toggle = item.querySelector('[data-lusena-quality-evidence-toggle]');
          if (item === selectedItem) {
            item.classList.add('is-open');
            if (toggle) toggle.setAttribute('aria-expanded', 'true');
          } else {
            item.classList.remove('is-open');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
          }
        });
      });
    }
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA PDP Quality",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 56
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 56
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding top (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding bottom (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Dlaczego LUSENA?"
    }
  ],
  "blocks": [
    {
      "type": "evidence",
      "name": "Evidence item",
      "limit": 4,
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "default": "shield-check",
          "options": [
            { "value": "shield-check", "label": "Shield Check" },
            { "value": "map-pin", "label": "Map Pin" },
            { "value": "layers", "label": "Layers" },
            { "value": "package", "label": "Package" },
            { "value": "sparkles", "label": "Sparkles" },
            { "value": "gift", "label": "Gift" }
          ]
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "OEKO-TEX® Standard 100"
        },
        {
          "type": "textarea",
          "id": "summary",
          "label": "Summary",
          "default": "Niezależny certyfikat potwierdzający brak substancji szkodliwych. Bezpieczny dla skóry wrażliwej, alergików i dzieci."
        },
        {
          "type": "textarea",
          "id": "detail",
          "label": "Expanded detail",
          "default": "Każda partia jedwabiu jest testowana przez akredytowane laboratorium. Numer certyfikatu znajdziesz na karcie dołączonej do produktu. Możesz go zweryfikować na oeko-tex.com/check."
        },
        {
          "type": "text",
          "id": "cta_label",
          "label": "CTA label",
          "default": "Sprawdź certyfikat →"
        },
        {
          "type": "url",
          "id": "cta_link",
          "label": "CTA link"
        },
        {
          "type": "checkbox",
          "id": "use_certificate_link",
          "label": "Use OEKO-TEX certificate file link",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "LUSENA PDP Quality",
      "settings": {
        "heading": "Dlaczego LUSENA?"
      },
      "blocks": [
        {
          "type": "evidence",
          "settings": {
            "icon": "shield-check",
            "title": "OEKO-TEX® Standard 100",
            "summary": "Niezależny certyfikat potwierdzający brak substancji szkodliwych. Bezpieczny dla skóry wrażliwej, alergików i dzieci.",
            "detail": "Każda partia jedwabiu jest testowana przez akredytowane laboratorium. Numer certyfikatu znajdziesz na karcie dołączonej do produktu. Możesz go zweryfikować na oeko-tex.com/check.",
            "cta_label": "Sprawdź certyfikat →",
            "cta_link": "/pages/nasza-jakosc",
            "use_certificate_link": true
          }
        },
        {
          "type": "evidence",
          "settings": {
            "icon": "map-pin",
            "title": "Jedwab z Suzhou — 600 lat tradycji",
            "summary": "Nasz jedwab pochodzi z regionu Shengze w Suzhou — światowej stolicy jedwabiu od ponad 600 lat.",
            "detail": "Lokalni producenci specjalizują się w jedwabiu Grade 6A o najdłuższych włóknach. To gładszy, trwalszy i bardziej lśniący materiał niż jedwab z innych regionów. Współpracujemy bezpośrednio z certyfikowanymi manufakturami.",
            "cta_label": "Więcej o pochodzeniu →",
            "cta_link": "/pages/o-nas"
          }
        },
        {
          "type": "evidence",
          "settings": {
            "icon": "layers",
            "title": "22 momme — optymalny standard",
            "summary": "Momme to jednostka gęstości jedwabiu. 22 momme to o 30% więcej niż branżowy standard 16–19 momme.",
            "detail": "Wyższe momme oznacza grubszy, bardziej trwały jedwab, który lepiej oddycha i zachowuje właściwości termoregulacyjne. 22 momme to optymalny balans między luksusowym dotykiem a wytrzymałością — bez nadmiernej wagi.",
            "cta_label": "Porównaj momme →",
            "cta_link": "/pages/nasza-jakosc"
          }
        },
        {
          "type": "evidence",
          "settings": {
            "icon": "package",
            "title": "Kontrola jakości w Polsce + wysyłka 24h",
            "summary": "Każdy produkt przechodzi kontrolę jakości w naszym magazynie w Polsce. Wysyłamy w ciągu 24 godzin roboczych.",
            "detail": "Sprawdzamy szwy, zamek, kolor i gramaturę. Produkty niespełniające standardów nie trafiają do sprzedaży. Dzięki lokalnej logistyce dostarczamy w 1–2 dni robocze via InPost lub kurier.",
            "cta_label": "Więcej o nas →",
            "cta_link": "/pages/nasza-jakosc"
          }
        }
      ]
    }
  ]
}
{% endschema %}
