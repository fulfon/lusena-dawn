{%- liquid
  assign product_form_id = 'LusenaProductForm-' | append: section.id
  assign current_variant = product.selected_or_first_available_variant
  assign price_per_night_cents = current_variant.price | divided_by: 365.0 | round
-%}

<section
  class="lusena-pdp"
  data-lusena-product-section
  style="
    --lusena-section-padding-top-mobile: {{ section.settings.padding_top_mobile }}px;
    --lusena-section-padding-bottom-mobile: {{ section.settings.padding_bottom_mobile }}px;
    --lusena-section-padding-top-desktop: {{ section.settings.padding_top }}px;
    --lusena-section-padding-bottom-desktop: {{ section.settings.padding_bottom }}px;
  "
>
  <script type="application/json" data-lusena-product-json>
    {{ product | json }}
  </script>

  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

  <div class="container">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-12 lg:gap-16">
      <div class="md:col-span-7 space-y-4{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
        {%- liquid
          assign initial_media = current_variant.featured_media | default: product.featured_media
          assign initial_preview = initial_media.preview_image | default: initial_media
          assign initial_alt_raw = initial_media.alt | default: initial_preview.alt | default: ''
          assign initial_alt = initial_alt_raw | split: '|' | first | strip
        -%}

        <div class="aspect-square bg-surface-2 overflow-hidden rounded-sm relative" data-lusena-media-stage>
          {%- if initial_preview != blank -%}
            {{
              initial_preview
              | image_url: width: 1600
              | image_tag:
                class: 'w-full h-full object-cover',
                loading: 'eager',
                widths: '600, 800, 1200, 1600',
                sizes: '(min-width: 768px) 55vw, 100vw',
                alt: initial_alt
            }}
          {%- else -%}
            {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
          {%- endif -%}

          {%- if product.tags contains 'bestseller' -%}
            <span class="absolute top-4 left-4 bg-white/90 px-3 py-1 text-xs uppercase tracking-wider font-medium backdrop-blur-sm">
              Best Seller
            </span>
          {%- endif -%}
        </div>

        <div
          class="lusena-media-thumbs"
          data-lusena-media-thumbs
          data-lusena-video-placeholder="{{ section.settings.video_placeholder | escape }}"
        >
          {%- for media in product.media -%}
            {%- liquid
              assign media_preview = media.preview_image | default: media
              assign media_alt_raw = media.alt | default: media_preview.alt | default: ''
              assign media_alt = media_alt_raw | split: '|' | first | strip
              assign thumb_label = media_alt
              if thumb_label == blank
                assign thumb_label = 'Zdjęcie ' | append: forloop.index
              endif
            -%}

            {%- if media_preview != blank -%}
              <button
                type="button"
                class="lusena-media-thumb"
                data-lusena-thumb
                data-media-id="{{ media.id }}"
                aria-label="{{ thumb_label | escape }}"
              >
                {{
                  media_preview
                  | image_url: width: 300
                  | image_tag:
                    class: 'w-full h-full object-cover',
                    loading: 'lazy',
                    widths: '120, 180, 240, 300',
                    sizes: '96px',
                    alt: media_alt
                }}
              </button>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>

      <div class="md:col-span-5 space-y-8 sticky top-32 self-start">
        <div class="space-y-4{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          {%- if section.settings.emotional_headline != blank -%}
            <span class="text-accent-gold font-serif italic text-lg">
              {{ section.settings.emotional_headline | escape }}
            </span>
          {%- endif -%}

          <div class="flex items-center gap-4 text-xs text-secondary border-b border-gray-100 pb-4">
            <div class="flex items-center gap-1">
              <div class="flex text-accent-gold" aria-hidden="true">
                {%- for i in (1..5) -%}
                  {% render 'lusena-icon', name: 'star', class: 'w-3 h-3 fill-current', stroke_width: 1.5 %}
                {%- endfor -%}
              </div>
              <a href="{{ section.settings.reviews_link }}" class="underline cursor-pointer">
                {{ section.settings.reviews_label | escape }}
              </a>
            </div>

            <div class="flex items-center gap-1">
              {% render 'lusena-icon', name: 'truck', class: 'w-3 h-3', stroke_width: 1.5 %}
              <span>{{ section.settings.trust_shipping | escape }}</span>
            </div>

            <div class="flex items-center gap-1">
              {% render 'lusena-icon', name: 'sparkles', class: 'w-3 h-3', stroke_width: 1.5 %}
              <span>{{ section.settings.trust_oeko | escape }}</span>
            </div>
          </div>

          <h1 class="text-3xl md:text-4xl font-serif text-primary">{{ product.title | escape }}</h1>

          {%- if section.settings.tagline != blank -%}
            <p class="text-secondary text-sm">{{ section.settings.tagline | escape }}</p>
          {%- endif -%}

          <div class="flex flex-col gap-1" data-lusena-price-wrap>
            <div class="flex items-baseline gap-4">
              <span class="text-2xl font-medium" data-lusena-price>
                {{ current_variant.price | money_without_trailing_zeros }}
              </span>
              {%- if current_variant.compare_at_price and current_variant.compare_at_price > current_variant.price -%}
                <span class="text-lg text-secondary/50 line-through" data-lusena-compare-at>
                  {{ current_variant.compare_at_price | money_without_trailing_zeros }}
                </span>
              {%- else -%}
                <span class="text-lg text-secondary/50 line-through hidden" data-lusena-compare-at></span>
              {%- endif -%}
            </div>
            <span
              class="text-xs text-accent-cta font-medium"
              data-lusena-price-per-night
              data-prefix="{{ section.settings.price_per_night_prefix | escape }}"
              data-suffix="{{ section.settings.price_per_night_suffix | escape }}"
            >
              {{ section.settings.price_per_night_prefix | escape }}
              {{ price_per_night_cents | money_without_trailing_zeros }}
              {{ section.settings.price_per_night_suffix | escape }}
            </span>
          </div>

          {%- if section.blocks.size > 0 -%}
            <ul class="space-y-2 py-2">
              {%- for block in section.blocks -%}
                {%- if block.type == 'benefit' -%}
                  <li class="flex items-start gap-3 text-sm text-secondary" {{ block.shopify_attributes }}>
                    <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-accent-gold shrink-0"></span>
                    {{ block.settings.text | escape }}
                  </li>
                {%- endif -%}
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </div>

        <div class="h-px bg-gray-100"></div>

        <div class="space-y-6{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}" data-lusena-variant-selectors>
          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              {%- liquid
                assign option_index = forloop.index0
                assign selected_value = current_variant.options[option_index]
                assign option_name_downcase = option.name | downcase
                assign swatch_count = option.values | map: 'swatch' | compact | size
                assign is_color = false
                if swatch_count > 0
                  assign is_color = true
                elsif option_name_downcase contains 'color' or option_name_downcase contains 'colour' or option_name_downcase contains 'kolor'
                  assign is_color = true
                endif
              -%}

              <fieldset
                class="space-y-3"
                data-lusena-option
                data-option-index="{{ option_index }}"
                {% if is_color %}data-lusena-option-type="color"{% endif %}
              >
                <legend class="text-sm font-medium text-secondary uppercase tracking-wider text-xs">
                  {{ option.name | escape }}:
                  <span class="text-primary font-semibold text-sm ml-1" data-lusena-selected>{{ selected_value | escape }}</span>
                </legend>

                <div class="flex flex-wrap gap-3">
                  {%- for value in option.values -%}
                    {%- liquid
                      assign is_selected = value.selected
                      assign option_disabled = true
                      if value.available
                        assign option_disabled = false
                      endif
                    -%}

                    {%- if is_color -%}
                      {%- liquid
                        assign swatch_value = null
                        assign swatch_focal_point = null

                        if value.swatch.image
                          assign image_url = value.swatch.image | image_url: width: 100
                          assign swatch_value = 'url(' | append: image_url | append: ')'
                          assign swatch_focal_point = value.swatch.image.presentation.focal_point
                        elsif value.swatch.color
                          assign swatch_value = 'rgb(' | append: value.swatch.color.rgb | append: ')'
                        endif

                        assign bg_class = ''
                        if swatch_value == null
                          assign bg_class = 'bg-gray-200'
                          assign value_downcase = value | downcase
                          case value_downcase
                            when 'beige'
                              assign bg_class = 'bg-[#E8E0D5]'
                            when 'midnight blue'
                              assign bg_class = 'bg-[#1B243B]'
                            when 'pearl white'
                              assign bg_class = 'bg-[#FDFCF8]'
                            when 'pink'
                              assign bg_class = 'bg-[#F3E5DC]'
                            when 'silver'
                              assign bg_class = 'bg-[#D6D6D6]'
                          endcase
                        endif
                      -%}

                      <label class="transition-all duration-200 relative flex items-center justify-center{% if option_disabled %} opacity-40 cursor-not-allowed{% endif %}">
                        <input
                          class="lusena-option__input visually-hidden"
                          type="radio"
                          name="option-{{ section.id }}-{{ option_index }}"
                          value="{{ value | escape }}"
                          {% if is_selected %}checked{% endif %}
                          {% if option_disabled %}disabled{% endif %}
                        >
                        <span
                          class="lusena-option__swatch w-10 h-10 rounded-full border border-gray-200 hover:brightness-95 shadow-sm {{ bg_class }}"
                          data-lusena-value
                          data-lusena-option-value="{{ value | escape }}"
                          title="{{ value | escape }}"
                          {% if swatch_value %}
                            style="
                              background: {{ swatch_value }};
                              background-size: cover;
                              {% if swatch_focal_point %}background-position: {{ swatch_focal_point }};{% endif %}
                            "
                          {% endif %}
                        ></span>
                        <span class="visually-hidden">{{ value | escape }}</span>
                      </label>
                    {%- else -%}
                      <label class="transition-all duration-200 relative flex items-center justify-center{% if option_disabled %} opacity-40 cursor-not-allowed{% endif %}">
                        <input
                          class="lusena-option__input visually-hidden"
                          type="radio"
                          name="option-{{ section.id }}-{{ option_index }}"
                          value="{{ value | escape }}"
                          {% if is_selected %}checked{% endif %}
                          {% if option_disabled %}disabled{% endif %}
                        >
                        <span
                          class="lusena-option__pill px-6 py-2 border text-sm min-w-[4rem] border-secondary/30 text-primary hover:border-primary"
                          data-lusena-value
                          data-lusena-option-value="{{ value | escape }}"
                        >
                          {{ value | escape }}
                        </span>
                      </label>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </fieldset>
            {%- endfor -%}
          {%- endunless -%}
        </div>

        <div class="pt-4 space-y-4{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          <product-form class="product-form" data-hide-errors="true">
            {%- form 'product',
              product,
              id: product_form_id,
              class: 'form',
              novalidate: 'novalidate',
              data-type: 'add-to-cart-form'
            -%}
              <input type="hidden" name="id" value="{{ current_variant.id }}" data-lusena-variant-id>
              <button
                id="main-cta"
                type="submit"
                data-lusena-atc
                class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-primary/20 disabled:pointer-events-none disabled:opacity-50 uppercase tracking-widest h-14 px-10 text-base bg-accent-cta text-white hover:bg-[#0E5E5A]/90 hover:brightness-110 w-full text-lg h-14"
                {% unless current_variant.available %}disabled{% endunless %}
              >
                <span data-lusena-add-to-cart-text>{{ section.settings.add_to_cart_label | escape }}</span>
                <span class="sold-out-message hidden">{{ 'products.product.sold_out' | t }}</span>
                {%- render 'loading-spinner' -%}
              </button>
            {%- endform -%}
          </product-form>

          <div class="flex items-center justify-center gap-2 text-xs text-secondary" data-lusena-stock>
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" data-lusena-stock-dot></span>
            <span
              data-lusena-stock-text
              data-in-stock="{{ section.settings.in_stock_label | escape }}"
              data-out-of-stock="{{ section.settings.out_of_stock_label | escape }}"
            >
              {%- if current_variant.available -%}
                {{ section.settings.in_stock_label | escape }}
              {%- else -%}
                {{ section.settings.out_of_stock_label | escape }}
              {%- endif -%}
            </span>
          </div>
        </div>

        <div class="p-4 bg-brand-bg/50 border border-brand-bg rounded-sm flex flex-col gap-2 text-sm{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          <div class="flex items-center gap-2 text-primary font-medium">
            {% render 'lusena-icon', name: 'shield-check', class: 'w-4 h-4 text-accent-cta', stroke_width: 1.5 %}
            <span>{{ section.settings.guarantee_heading | escape }}</span>
          </div>
          <p class="text-secondary text-xs pl-6">{{ section.settings.guarantee_body | escape }}</p>
        </div>

        <div class="w-full{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          {%- for block in section.blocks -%}
            {%- if block.type == 'accordion' -%}
              <details class="border-b border-secondary/20" {{ block.shopify_attributes }}>
                <summary class="flex items-center justify-between py-4 font-medium transition-all hover:text-accent-cta cursor-pointer">
                  {{ block.settings.heading | escape }}
                  {% render 'lusena-icon', name: 'chevron-down', class: 'h-4 w-4 shrink-0 transition-transform duration-200 lusena-pdp__chevron', stroke_width: 1.5 %}
                </summary>
                <div class="overflow-hidden text-sm">
                  <div class="pb-4 pt-0 text-secondary">
                    {{ block.settings.content }}
                  </div>
                </div>
              </details>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>

  {%- if section.blocks.size > 0 -%}
    {%- assign has_cross_sell = false -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'cross_sell' and block.settings.product != blank -%}
        {%- assign has_cross_sell = true -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if has_cross_sell -%}
      <div class="container">
        <div class="border-t border-brand-bg pt-12 md:pt-24">
          <div class="text-center mb-12{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
            <h2 class="text-2xl md:text-3xl font-serif text-primary">{{ section.settings.cross_sell_heading | escape }}</h2>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {%- for block in section.blocks -%}
              {%- if block.type == 'cross_sell' and block.settings.product != blank -%}
                <div {% if settings.animations_reveal_on_scroll %}class="scroll-trigger animate--slide-in" data-cascade{% endif %}>
                  {% render 'lusena-product-card', product: block.settings.product, show_secondary_image: true %}
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- endif -%}
  {%- endif -%}

  {%- assign reviews_count = 0 -%}
  {%- for block in section.blocks -%}
    {%- if block.type == 'pdp_review' -%}
      {%- assign reviews_count = reviews_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if reviews_count > 0 -%}
    <div class="mt-24 border-t border-brand-bg pt-24 bg-surface-1 w-full">
      <div class="container pb-24">
        <div class="flex items-center justify-between mb-12{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          <h2 class="text-2xl md:text-3xl font-serif text-primary">{{ section.settings.pdp_reviews_heading | escape }}</h2>
          {%- if section.settings.pdp_reviews_button_label != blank and section.settings.pdp_reviews_button_link != blank -%}
            <a
              href="{{ section.settings.pdp_reviews_button_link }}"
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-primary/20 disabled:pointer-events-none disabled:opacity-50 uppercase tracking-widest h-12 px-8 py-3 border border-primary bg-transparent text-primary hover:bg-surface-2"
            >
              {{ section.settings.pdp_reviews_button_label | escape }}
            </a>
          {%- endif -%}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {%- for block in section.blocks -%}
            {%- if block.type == 'pdp_review' -%}
              <div
                class="bg-white p-8 space-y-4{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                {% if settings.animations_reveal_on_scroll %}
                  data-cascade
                {% endif %}
                {{ block.shopify_attributes }}
              >
                <div class="flex gap-1 text-accent-gold" aria-hidden="true">
                  {%- for i in (1..5) -%}
                    {% render 'lusena-icon', name: 'star', class: 'w-4 h-4 fill-current', stroke_width: 1.5 %}
                  {%- endfor -%}
                </div>
                <blockquote class="font-serif text-lg leading-relaxed text-primary">
                  "{{ block.settings.quote | escape }}"
                </blockquote>
                <div class="text-xs font-medium tracking-widest uppercase text-secondary">
                  — {{ block.settings.author | escape }}
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  {%- endif -%}

  <div
    class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-secondary/10 p-4 transition-transform duration-300 transform md:hidden flex items-center justify-between gap-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] translate-y-full"
    data-lusena-sticky-atc
  >
    <div class="flex flex-col">
      <span class="text-sm font-medium text-primary truncate max-w-[150px]">{{ product.title | escape }}</span>
      <span class="text-xs text-secondary" data-lusena-sticky-price>{{ current_variant.price | money_without_trailing_zeros }}</span>
    </div>
    <button
      type="submit"
      form="{{ product_form_id }}"
      data-lusena-sticky-atc-button
      class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-primary/20 disabled:pointer-events-none disabled:opacity-50 uppercase tracking-widest h-9 px-4 text-xs bg-accent-cta text-white hover:bg-[#0E5E5A]/90 hover:brightness-110 w-full max-w-[120px]"
      {% unless current_variant.available %}disabled{% endunless %}
    >
      {{ section.settings.sticky_add_to_cart_label | escape }}
    </button>
  </div>
</section>

{% stylesheet %}
  .lusena-pdp {
    padding-top: var(--lusena-section-padding-top-mobile);
    padding-bottom: var(--lusena-section-padding-bottom-mobile);
  }

  @media (min-width: 768px) {
    .lusena-pdp {
      padding-top: var(--lusena-section-padding-top-desktop);
      padding-bottom: var(--lusena-section-padding-bottom-desktop);
    }
  }

  .lusena-pdp .lusena-option__input:checked + .lusena-option__pill {
    border-color: var(--primary);
    background-color: var(--primary);
    color: #fff;
  }

  .lusena-pdp .lusena-option__input:checked + .lusena-option__swatch {
    border-color: var(--primary);
    outline: 1px solid var(--primary);
    outline-offset: 2px;
  }

  .lusena-pdp [data-lusena-media-stage] img {
    transition: opacity 200ms ease-in-out;
  }

  @media (prefers-reduced-motion: reduce) {
    .lusena-pdp [data-lusena-media-stage] img {
      transition: none;
    }
  }

  .lusena-pdp .lusena-media-thumbs {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 4px;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .lusena-pdp .lusena-media-thumbs::-webkit-scrollbar {
    height: 6px;
  }

  .lusena-pdp .lusena-media-thumbs::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 999px;
  }

  .lusena-pdp .lusena-media-thumb {
    width: 96px;
    flex: 0 0 auto;
    aspect-ratio: 1 / 1;
    border: 1px solid rgba(0, 0, 0, 0.12);
    border-radius: 2px;
    overflow: hidden;
    background: var(--surface-2);
    scroll-snap-align: start;
    transition: transform 200ms ease, border-color 200ms ease, outline-color 200ms ease;
  }

  .lusena-pdp .lusena-media-thumb:hover {
    transform: translateY(-1px);
    border-color: rgba(0, 0, 0, 0.25);
  }

  .lusena-pdp .lusena-media-thumb[aria-current='true'] {
    border-color: var(--primary);
    outline: 1px solid var(--primary);
    outline-offset: 2px;
  }

  @media (min-width: 768px) {
    .lusena-pdp .lusena-media-thumb {
      width: 104px;
    }
  }

  .lusena-pdp details[open] .lusena-pdp__chevron {
    transform: rotate(180deg);
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const root = document.querySelector('[data-lusena-product-section]');
    if (!root) return;

    const productJsonEl = root.querySelector('[data-lusena-product-json]');
    const variantIdInput = root.querySelector('[data-lusena-variant-id]');
    const priceEl = root.querySelector('[data-lusena-price]');
    const compareAtEl = root.querySelector('[data-lusena-compare-at]');
    const pricePerNightEl = root.querySelector('[data-lusena-price-per-night]');
    const stickyBar = root.querySelector('[data-lusena-sticky-atc]');
    const stickyPrice = root.querySelector('[data-lusena-sticky-price]');
    const stockText = root.querySelector('[data-lusena-stock-text]');
    const stockDot = root.querySelector('[data-lusena-stock-dot]');
    const atcButton = root.querySelector('[data-lusena-atc]');
    const stickyAtcButton = root.querySelector('[data-lusena-sticky-atc-button]');

    const pricePerNightPrefix = pricePerNightEl?.dataset?.prefix ?? '';
    const pricePerNightSuffix = pricePerNightEl?.dataset?.suffix ?? '';

    let product;
    try {
      product = JSON.parse(productJsonEl.textContent);
    } catch (e) {
      return;
    }

    const stageImg = root.querySelector('[data-lusena-media-stage] img');
    const stageSizes = stageImg?.getAttribute('sizes') || '';
    const thumbsWrap = root.querySelector('[data-lusena-media-thumbs]');
    const thumbEls = thumbsWrap ? Array.from(thumbsWrap.querySelectorAll('[data-lusena-thumb]')) : [];
    const thumbsById = new Map(
      thumbEls
        .map((el) => {
          const id = el?.dataset?.mediaId;
          return id ? [String(id), el] : null;
        })
        .filter(Boolean)
    );

    const normalizeImageUrl = (src) => {
      if (!src) return null;
      if (src.startsWith('//')) return `https:${src}`;
      return src;
    };

    const urlWithWidth = (src, width) => {
      const normalized = normalizeImageUrl(src);
      if (!normalized) return null;
      try {
        const u = new URL(normalized);
        u.searchParams.set('width', String(width));
        return u.toString();
      } catch (e) {
        return normalized;
      }
    };

    const setResponsiveImage = ({ img, src, widths, sizes, alt }) => {
      if (!img || !src) return;
      const normalized = normalizeImageUrl(src);
      if (!normalized) return;

      const maxWidth = widths[widths.length - 1];
      const srcWithWidth = urlWithWidth(normalized, maxWidth);
      const srcset = widths
        .map((w) => {
          const u = urlWithWidth(normalized, w);
          return u ? `${u} ${w}w` : null;
        })
        .filter(Boolean)
        .join(', ');

      if (srcWithWidth) img.src = srcWithWidth;
      if (srcset) img.setAttribute('srcset', srcset);
      if (sizes) img.setAttribute('sizes', sizes);
      if (typeof alt === 'string') img.alt = alt;
    };

    const findMediaById = (mediaId) => {
      if (!mediaId) return null;
      const idString = String(mediaId);
      return product?.media?.find((m) => String(m?.id) === idString) || null;
    };

    const normalizeKey = (value) => (typeof value === 'string' ? value.trim().toLowerCase() : '');

    const parseAlt = (alt) => {
      const raw = typeof alt === 'string' ? alt : '';
      const parts = raw.split('|').map((p) => p.trim()).filter(Boolean);
      const cleanAlt = parts.length ? parts[0] : '';
      const tag = parts.length > 1 ? parts[parts.length - 1] : '';

      const shared = /^\[shared\]$/i.test(tag);
      const colorMatch = tag.match(/^\[color=(.+)\]$/i);
      const colorTag = colorMatch ? colorMatch[1].trim() : null;

      return { cleanAlt, shared, colorTag };
    };

    const getMediaAltRaw = (media) => media?.alt || media?.preview_image?.alt || '';

    const hasAnyTagging = () =>
      Array.isArray(product?.media) &&
      product.media.some((m) => {
        const { shared, colorTag } = parseAlt(getMediaAltRaw(m));
        return shared || !!colorTag;
      });

    const getColorOptionIndex = () => {
      const fieldset = root.querySelector('[data-lusena-option-type="color"]');
      if (!fieldset) return null;
      const idx = Number(fieldset.dataset.optionIndex);
      return Number.isFinite(idx) ? idx : null;
    };

    const getSelectedColorForVariant = (variant) => {
      const colorIndex = getColorOptionIndex();
      if (colorIndex === null) return null;
      const options = variant?.options;
      if (!Array.isArray(options)) return null;
      return options[colorIndex] || null;
    };

    const getVisibleMediaForColor = (color) => {
      const media = Array.isArray(product?.media) ? product.media : [];
      if (!media.length) return { colorMedia: [], sharedMedia: [], visible: [], taggingEnabled: false };

      const taggingEnabled = hasAnyTagging();
      if (!taggingEnabled || !color) {
        return { colorMedia: [], sharedMedia: [], visible: media, taggingEnabled };
      }

      const normalizedColor = normalizeKey(color);
      const colorMedia = [];
      const sharedMedia = [];

      media.forEach((m) => {
        const { shared, colorTag } = parseAlt(getMediaAltRaw(m));
        const isSharedEffective = shared || (!colorTag && taggingEnabled);

        if (colorTag && normalizeKey(colorTag) === normalizedColor) colorMedia.push(m);
        else if (isSharedEffective) sharedMedia.push(m);
      });

      const visible = colorMedia.length ? [...colorMedia, ...sharedMedia] : media;
      return { colorMedia, sharedMedia, visible, taggingEnabled };
    };

    const state = {
      activeIndex: 0,
      colorMediaLength: 0,
    };

    const setActiveThumb = (activeMediaId) => {
      thumbEls.forEach((el) => el.removeAttribute('aria-current'));
      if (!activeMediaId) return;
      const el = thumbsById.get(String(activeMediaId));
      if (el) el.setAttribute('aria-current', 'true');
    };

    const applyThumbOrderAndVisibility = (visibleMedia) => {
      if (!thumbsWrap) return;
      const visibleIds = new Set(visibleMedia.map((m) => String(m?.id)));

      thumbEls.forEach((el) => {
        const id = String(el?.dataset?.mediaId || '');
        el.hidden = !visibleIds.has(id);
      });

      visibleMedia.forEach((m) => {
        const el = thumbsById.get(String(m?.id));
        if (el) thumbsWrap.appendChild(el);
      });
    };

    const setStageByMedia = (media) => {
      if (!stageImg || !media) return;
      const src = media?.preview_image?.src || media?.src;
      if (!src) return;

      const { cleanAlt } = parseAlt(getMediaAltRaw(media));
      stageImg.style.opacity = '0';
      requestAnimationFrame(() => {
        setResponsiveImage({
          img: stageImg,
          src,
          widths: [600, 800, 1200, 1600],
          sizes: stageSizes,
          alt: cleanAlt,
        });
        stageImg.style.opacity = '1';
      });
    };

    const selectMediaIndex = (index, visibleMedia) => {
      const safeIndex = Math.max(0, Math.min(index, visibleMedia.length - 1));
      const media = visibleMedia[safeIndex];
      state.activeIndex = safeIndex;
      setStageByMedia(media);
      setActiveThumb(media?.id);
    };

    const updateGalleryForVariant = (variant) => {
      if (!variant) return;
      const color = getSelectedColorForVariant(variant);
      const { visible, colorMedia } = getVisibleMediaForColor(color);
      if (!visible.length) return;

      const featuredMediaId =
        variant?.featured_media && typeof variant.featured_media === 'object' ? variant.featured_media.id : variant?.featured_media;
      const featuredMedia = featuredMediaId ? findMediaById(featuredMediaId) || variant.featured_media : null;
      const featuredId = featuredMedia?.id ? String(featuredMedia.id) : null;

      const previousColorLength = state.colorMediaLength;
      const wasOnShared = previousColorLength > 0 && state.activeIndex >= previousColorLength;

      state.colorMediaLength = colorMedia.length;

      applyThumbOrderAndVisibility(visible);

      if (wasOnShared && colorMedia.length) {
        selectMediaIndex(0, visible);
        return;
      }

      if (state.activeIndex === 0 && featuredId) {
        const featuredIndex = visible.findIndex((m) => String(m?.id) === featuredId);
        if (featuredIndex >= 0) {
          selectMediaIndex(featuredIndex, visible);
          return;
        }
      }

      if (colorMedia.length) {
        const nextIndex = Math.min(state.activeIndex, colorMedia.length - 1);
        selectMediaIndex(nextIndex, visible);
        return;
      }

      selectMediaIndex(state.activeIndex, visible);
    };

    const moneyFormat = (cents) => {
      if (window?.Shopify?.formatMoney) {
        return window.Shopify.formatMoney(cents, window.Shopify.money_format);
      }
      return `${(cents / 100).toFixed(2)}`;
    };

    const getSelectedOptions = () => {
      const optionFieldsets = root.querySelectorAll('[data-lusena-option]');
      const values = [];
      optionFieldsets.forEach((fieldset) => {
        const input = fieldset.querySelector('input[type="radio"]:checked');
        values.push(input ? input.value : null);
      });
      return values;
    };

    const findVariant = (options) =>
      product?.variants?.find((v) => {
        if (!v?.options) return false;
        return v.options.every((opt, idx) => opt === options[idx]);
      });

    const setSelectedLabel = () => {
      const optionFieldsets = root.querySelectorAll('[data-lusena-option]');
      optionFieldsets.forEach((fieldset) => {
        const selected = fieldset.querySelector('input[type="radio"]:checked')?.value;
        const label = fieldset.querySelector('[data-lusena-selected]');
        if (label && selected) label.textContent = selected;
      });
    };

    const updateUIForVariant = (variant) => {
      if (!variant) return;
      if (variantIdInput) variantIdInput.value = variant.id;

      if (priceEl) priceEl.textContent = moneyFormat(variant.price);
      if (stickyPrice) stickyPrice.textContent = moneyFormat(variant.price);

      const compareAt = variant.compare_at_price;
      if (compareAtEl) {
        if (compareAt && compareAt > variant.price) {
          compareAtEl.textContent = moneyFormat(compareAt);
          compareAtEl.classList.remove('hidden');
        } else {
          compareAtEl.textContent = '';
          compareAtEl.classList.add('hidden');
        }
      }

      if (pricePerNightEl) {
        const perNightCents = Math.round(variant.price / 365);
        pricePerNightEl.textContent = `${pricePerNightPrefix}${moneyFormat(perNightCents)}${pricePerNightSuffix}`;
      }

      const available = !!variant.available;
      if (stockText) {
        const inStock = stockText.dataset.inStock ?? '';
        const outOfStock = stockText.dataset.outOfStock ?? '';
        stockText.textContent = available ? inStock : outOfStock;
      }
      if (stockDot) {
        stockDot.classList.toggle('bg-green-500', available);
        stockDot.classList.toggle('bg-red-500', !available);
      }
      if (atcButton) atcButton.disabled = !available;
      if (stickyAtcButton) stickyAtcButton.disabled = !available;

      updateGalleryForVariant(variant);
    };

    root.addEventListener('change', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLInputElement)) return;
      if (target.type !== 'radio') return;

      setSelectedLabel();

      const options = getSelectedOptions();
      const variant = findVariant(options);
      updateUIForVariant(variant);
    });

    if (thumbEls.length) {
      thumbEls.forEach((el) => {
        el.addEventListener('click', () => {
          const id = el?.dataset?.mediaId ? String(el.dataset.mediaId) : null;
          if (!id) return;

          const colorIndex = getColorOptionIndex();
          const variant =
            findVariant(getSelectedOptions()) ||
            product?.variants?.find((v) => String(v.id) === String(variantIdInput?.value || '')) ||
            product?.variants?.[0];
          const color = colorIndex !== null ? getSelectedColorForVariant(variant) : null;
          const { visible } = getVisibleMediaForColor(color);

          const idx = visible.findIndex((m) => String(m?.id) === id);
          if (idx < 0) return;
          selectMediaIndex(idx, visible);
        });
      });
    }

    setSelectedLabel();
    updateUIForVariant(
      findVariant(getSelectedOptions()) ||
        product?.variants?.find((v) => String(v.id) === String(variantIdInput?.value || '')) ||
        product?.variants?.[0]
    );

    const mainCta = root.querySelector('#main-cta');
    if (!stickyBar || !mainCta) return;

    const show = () => stickyBar.classList.remove('translate-y-full');
    const hide = () => stickyBar.classList.add('translate-y-full');

    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) hide();
            else show();
          });
        },
        { rootMargin: '0px 0px -10% 0px' }
      );
      io.observe(mainCta);
      return;
    }

    const onScroll = () => {
      const rect = mainCta.getBoundingClientRect();
      if (rect.bottom < 0) show();
      else hide();
    };
    onScroll();
    window.addEventListener('scroll', onScroll, { passive: true });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA product (draft)",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 96
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding top (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding bottom (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "text",
      "id": "emotional_headline",
      "label": "Emotional headline",
      "default": "Wake up without creases."
    },
    {
      "type": "text",
      "id": "reviews_label",
      "label": "Reviews label",
      "default": "127 Reviews"
    },
    {
      "type": "url",
      "id": "reviews_link",
      "label": "Reviews link"
    },
    {
      "type": "text",
      "id": "trust_shipping",
      "label": "Trust: shipping",
      "default": "Free Shipping"
    },
    {
      "type": "text",
      "id": "trust_oeko",
      "label": "Trust: OEKO-TEX",
      "default": "OEKO-TEX®"
    },
    {
      "type": "text",
      "id": "tagline",
      "label": "Tagline",
      "default": "The ultimate anti-aging tool for your skin and hair."
    },
    {
      "type": "text",
      "id": "price_per_night_prefix",
      "label": "Price-per-night prefix",
      "default": "Only "
    },
    {
      "type": "text",
      "id": "price_per_night_suffix",
      "label": "Price-per-night suffix",
      "default": " / night (based on 1 year use)"
    },
    {
      "type": "text",
      "id": "add_to_cart_label",
      "label": "Add to cart label",
      "default": "Add to Cart - Ships Today"
    },
    {
      "type": "text",
      "id": "sticky_add_to_cart_label",
      "label": "Sticky add to cart label",
      "default": "Add to Cart"
    },
    {
      "type": "text",
      "id": "in_stock_label",
      "label": "In-stock label",
      "default": "In stock, ready to ship."
    },
    {
      "type": "text",
      "id": "out_of_stock_label",
      "label": "Out-of-stock label",
      "default": "Out of stock."
    },
    {
      "type": "text",
      "id": "guarantee_heading",
      "label": "Guarantee heading",
      "default": "60-Day Sleep Guarantee"
    },
    {
      "type": "text",
      "id": "guarantee_body",
      "label": "Guarantee body",
      "default": "Try it for 60 nights. If you don't feel the difference, return it for a full refund. No questions asked."
    },
    {
      "type": "text",
      "id": "video_placeholder",
      "label": "Video placeholder",
      "default": "Video Preview"
    },
    {
      "type": "text",
      "id": "cross_sell_heading",
      "label": "Cross-sell heading",
      "default": "Pairs Well With"
    },
    {
      "type": "text",
      "id": "pdp_reviews_heading",
      "label": "PDP reviews heading",
      "default": "Verified Reviews"
    },
    {
      "type": "text",
      "id": "pdp_reviews_button_label",
      "label": "PDP reviews button label",
      "default": "Write a Review"
    },
    {
      "type": "url",
      "id": "pdp_reviews_button_link",
      "label": "PDP reviews button link"
    }
  ],
  "blocks": [
    {
      "type": "benefit",
      "name": "Benefit",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Reduces sleep wrinkles and morning creases"
        }
      ]
    },
    {
      "type": "accordion",
      "name": "Accordion",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Product Details"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<ul><li>100% Mulberry Silk (22 momme)</li><li>Grade 6A fibers</li><li>OEKO-TEX® Standard 100 Certified</li><li>Hidden zipper closure</li></ul>"
        }
      ]
    },
    {
      "type": "cross_sell",
      "name": "Cross-sell product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    },
    {
      "type": "pdp_review",
      "name": "PDP review",
      "settings": [
        {
          "type": "text",
          "id": "author",
          "label": "Author",
          "default": "Karolina P."
        },
        {
          "type": "text",
          "id": "quote",
          "label": "Quote",
          "default": "I have acne prone skin and this pillowcase has been a game changer. Less breakouts and my hair is smoother."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "LUSENA product (draft)",
      "blocks": [
        { "type": "benefit" },
        {
          "type": "benefit",
          "settings": {
            "text": "Keeps skin hydrated (doesn't absorb cream)"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "text": "Prevents hair breakage and frizz"
          }
        },
        { "type": "accordion" },
        {
          "type": "accordion",
          "settings": {
            "heading": "Care Guide",
            "content": "<p>Machine wash cold on delicate cycle. Use silk-safe detergent. Line dry out of direct sunlight. Do not bleach.</p>"
          }
        },
        {
          "type": "accordion",
          "settings": {
            "heading": "Shipping & Returns",
            "content": "<p>Ships within 24 hours. Free delivery via InPost. Returns accepted within 60 days even if used.</p>"
          }
        },
        {
          "type": "pdp_review",
          "settings": {
            "author": "Karolina P.",
            "quote": "I have acne prone skin and this pillowcase has been a game changer. Less breakouts and my hair is smoother."
          }
        },
        {
          "type": "pdp_review",
          "settings": {
            "author": "Ewa M.",
            "quote": "The cooling effect is real. I sleep so much better and wake up without a puffy face."
          }
        }
      ]
    }
  ]
}
{% endschema %}
