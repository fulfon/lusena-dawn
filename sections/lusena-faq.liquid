<section
  class="bg-surface-1 lusena-faq"
  data-lusena-faq
  style="
    --lusena-section-padding-top-mobile: {{ section.settings.padding_top_mobile }}px;
    --lusena-section-padding-bottom-mobile: {{ section.settings.padding_bottom_mobile }}px;
    --lusena-section-padding-top-desktop: {{ section.settings.padding_top }}px;
    --lusena-section-padding-bottom-desktop: {{ section.settings.padding_bottom }}px;
  "
>
  <div class="container max-w-3xl">
    <div class="text-center mb-16{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
      <h2 class="text-3xl md:text-4xl font-serif text-primary mb-4">{{ section.settings.heading | escape }}</h2>
      {%- if section.settings.subheading != blank -%}
        <p class="text-secondary">{{ section.settings.subheading | escape }}</p>
      {%- endif -%}
    </div>

    <div class="w-full">
      {%- for block in section.blocks -%}
        <details
          class="lusena-faq__item border-b border-secondary/20{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
          {% if settings.animations_reveal_on_scroll %}
            data-cascade
          {% endif %}
          {{ block.shopify_attributes }}
        >
          <summary class="flex items-center justify-between py-4 font-medium transition-all hover:text-accent-cta cursor-pointer">
            {{ block.settings.question | escape }}
            {% render 'lusena-icon', name: 'chevron-down', class: 'h-4 w-4 shrink-0 transition-transform duration-200 lusena-faq__chevron', stroke_width: 2 %}
          </summary>
          <div class="lusena-faq__content overflow-hidden text-sm">
            <div class="lusena-faq__content-inner pb-4 pt-0 text-secondary">
              {{ block.settings.answer }}
            </div>
          </div>
        </details>
      {%- endfor -%}
    </div>
  </div>
</section>

{% stylesheet %}
  .lusena-faq {
    padding-top: var(--lusena-section-padding-top-mobile);
    padding-bottom: var(--lusena-section-padding-bottom-mobile);
  }

  @media (min-width: 768px) {
    .lusena-faq {
      padding-top: var(--lusena-section-padding-top-desktop);
      padding-bottom: var(--lusena-section-padding-bottom-desktop);
    }
  }

  .lusena-faq__item[data-state='open'] .lusena-faq__chevron {
    transform: rotate(180deg);
  }

  .lusena-faq__item summary {
    font-family: 'Source Serif 4', serif;
    font-size: 16px;
    line-height: 24px;
    font-weight: 500;
    letter-spacing: normal;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .lusena-faq__item {
    contain: layout style;
  }

  .lusena-faq__content {
    overflow: hidden;
    height: 0;
    transition: height 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    will-change: height;
  }

  /* GPU-composited overlay: opacity+transform run at 120Hz on ProMotion */
  @supports (touch-action: manipulation) {
    .lusena-faq__content-inner {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.18s ease, transform 0.18s ease;
    }
    .lusena-faq__item[data-state='closed'] .lusena-faq__content-inner,
    .lusena-faq__item[data-state='closing'] .lusena-faq__content-inner {
      opacity: 0;
      transform: translateY(-6px);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .lusena-faq__content {
      transition: none;
      will-change: auto;
    }
    .lusena-faq__content-inner {
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const root = document.querySelector('[data-lusena-faq]');
    if (!root) return;

    const prefersReducedMotion = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
    const items = Array.from(root.querySelectorAll('details.lusena-faq__item'));

    const getContent = (details) => details.querySelector('.lusena-faq__content');
    const getInner = (content) => content.querySelector('.lusena-faq__content-inner') || content.firstElementChild;
    const clearContentTransition = (content) => {
      if (typeof content._lusenaFaqOnEnd === 'function') {
        content.removeEventListener('transitionend', content._lusenaFaqOnEnd);
        content._lusenaFaqOnEnd = null;
      }
    };

    const closeItem = (details) => {
      const content = getContent(details);
      if (!content) return;
      clearContentTransition(content);

      if (prefersReducedMotion) {
        details.open = false;
        details.dataset.state = 'closed';
        content.style.height = '0px';
        return;
      }

      const h = content.offsetHeight;
      content.style.height = h + 'px';
      details.dataset.state = 'closing';

      requestAnimationFrame(() => {
        content.style.height = '0px';
      });

      const onEnd = (e) => {
        if (e.target !== content || e.propertyName !== 'height') return;
        content.removeEventListener('transitionend', onEnd);
        content._lusenaFaqOnEnd = null;
        details.dataset.state = 'closed';
        details.open = false;
        content.style.height = '0px';
      };
      content._lusenaFaqOnEnd = onEnd;
      content.addEventListener('transitionend', onEnd);
    };

    const openItem = (details) => {
      const content = getContent(details);
      if (!content) return;
      clearContentTransition(content);

      // Accordion behavior: only one open at a time.
      items.forEach((other) => {
        if (other !== details && other.open) closeItem(other);
      });

      if (prefersReducedMotion) {
        details.open = true;
        details.dataset.state = 'open';
        content.style.height = 'auto';
        return;
      }

      details.open = true;
      content.style.height = '0px';
      details.dataset.state = 'open';

      const inner = getInner(content);
      const targetH = inner ? inner.scrollHeight : content.scrollHeight;

      requestAnimationFrame(() => {
        content.style.height = targetH + 'px';
      });

      const onEnd = (e) => {
        if (e.target !== content || e.propertyName !== 'height') return;
        content.removeEventListener('transitionend', onEnd);
        content._lusenaFaqOnEnd = null;
        content.style.height = 'auto';
      };
      content._lusenaFaqOnEnd = onEnd;
      content.addEventListener('transitionend', onEnd);
    };

    // Init: set all closed items to height 0, open items to auto
    items.forEach((details) => {
      const content = getContent(details);
      if (!content) return;
      if (details.open) {
        details.dataset.state = 'open';
        content.style.height = 'auto';
      } else {
        details.dataset.state = 'closed';
        content.style.height = '0px';
      }
    });

    const onFastTap = (el, callback) => {
      let startX, startY, handled;
      el.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        handled = false;
      }, { passive: true });
      el.addEventListener('touchend', (e) => {
        const t = e.changedTouches[0];
        if (Math.abs(t.clientX - startX) < 10 && Math.abs(t.clientY - startY) < 10) {
          handled = true;
          e.preventDefault();
          callback(e);
        }
      }, { passive: false });
      el.addEventListener('click', (e) => {
        e.preventDefault();
        if (!handled) callback(e);
        handled = false;
      });
    };

    items.forEach((details) => {
      const summary = details.querySelector('summary');
      if (!summary) return;

      onFastTap(summary, () => {
        if (details.open) closeItem(details);
        else openItem(details);
      });
    });

    if (window.Shopify?.designMode) {
      document.addEventListener('shopify:section:load', () => {
        items.forEach((details) => {
          const content = getContent(details);
          if (!content) return;
          if (details.open) {
            details.dataset.state = 'open';
            content.style.height = 'auto';
          } else {
            details.dataset.state = 'closed';
            content.style.height = '0px';
          }
        });
      });
    }
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA FAQ (draft)",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 56
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (desktop)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 56
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding top (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding bottom (mobile)",
      "min": 0,
      "max": 240,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Common Questions"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Everything you need to know about sleeping on silk."
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Item",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "Is it real mulberry silk?"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>Yes, absolutely. We use only 100% Grade 6A Mulberry Silk, 22 momme thickness. It is the highest grade available, ensuring durability and the ultimate smooth feel.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "LUSENA FAQ (draft)",
      "blocks": [
        {
          "type": "item",
          "settings": {
            "question": "Is it real mulberry silk?",
            "answer": "<p>Yes, absolutely. We use only 100% Grade 6A Mulberry Silk, 22 momme thickness. It is the highest grade available, ensuring durability and the ultimate smooth feel.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "question": "How do I wash it?",
            "answer": "<p>LUSENA silk is machine washable on a delicate/silk cycle (30Â°C) using pH-neutral detergent. You can also hand wash. Air dry out of direct sunlight.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "question": "Do you offer a trial period?",
            "answer": "<p>We offer a 60-night sleep trial. If you don't love it, return it for a full refund. We believe in our quality that much.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "question": "Where do you ship from?",
            "answer": "<p>We are a Polish brand and ship directly from our warehouse in Warsaw. Domestic delivery typically takes 1-2 business days.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
