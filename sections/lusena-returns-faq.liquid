<section
  class="bg-brand-bg lusena-returns-faq"
  style="
    --lusena-section-padding-top-mobile: {{ section.settings.padding_top_mobile }}px;
    --lusena-section-padding-bottom-mobile: {{ section.settings.padding_bottom_mobile }}px;
    --lusena-section-padding-top-desktop: {{ section.settings.padding_top }}px;
    --lusena-section-padding-bottom-desktop: {{ section.settings.padding_bottom }}px;
  "
>
  <div class="container lusena-returns-faq__container mx-auto">
    <div class="text-center mb-12 space-y-3">
      <span class="text-accent-gold text-sm tracking-widest uppercase font-semibold{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
        {{ section.settings.faq_kicker | escape }}
      </span>
      <h2 class="text-3xl md:text-5xl font-serif text-primary{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
        {{ section.settings.faq_heading | escape }}
      </h2>
    </div>

    <div
      class="w-full px-8 py-4{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
      data-lusena-returns-faq
      data-lusena-accordion-root
      data-lusena-accordion-single
      data-lusena-accordion-collapsible
      {% if settings.animations_reveal_on_scroll %}
        data-cascade
      {% endif %}
    >
      {%- for block in section.blocks -%}
        {%- if block.type == 'faq' -%}
          <div
            class="lusena-returns-faq__item{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
            data-lusena-accordion-item
            data-lusena-accordion-value="faq-{{ block.id }}"
            {{ block.shopify_attributes }}
          >
            <div class="flex">
              <button
                type="button"
                class="lusena-returns-faq__summary"
                data-lusena-accordion-trigger
                data-state="closed"
                aria-expanded="false"
              >
                {{ block.settings.question | escape }}
                {% render 'lusena-icon', name: 'chevron-down', class: 'h-4 w-4 shrink-0 transition-transform duration-200 lusena-returns-faq__chevron', stroke_width: 1.5 %}
              </button>
            </div>
            <div class="lusena-returns-faq__content overflow-hidden text-sm" data-lusena-accordion-content data-state="closed">
              <div class="lusena-returns-faq__answer">
                {{ block.settings.answer }}
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    <div class="text-center mt-12{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
      <p class="text-secondary mb-4">{{ section.settings.contact_prompt | escape }}</p>
      {%- if section.settings.contact_button_label != blank and section.settings.contact_button_link != blank -%}
        <a
          href="{{ section.settings.contact_button_link }}"
          class="lusena-returns-faq__contact-button"
        >
          {{ section.settings.contact_button_label | escape }}
        </a>
      {%- endif -%}
    </div>
  </div>
</section>

{% stylesheet %}
  .lusena-returns-faq {
    padding-top: var(--lusena-section-padding-top-mobile);
    padding-bottom: var(--lusena-section-padding-bottom-mobile);
  }

  .lusena-returns-faq__container {
    max-width: 76.8rem !important;
  }

  .lusena-returns-faq__item {
    border-bottom: 1px solid rgb(74 74 74 / 0.2);
  }

  .lusena-returns-faq__summary {
    display: flex;
    flex: 1;
    align-items: center;
    justify-content: space-between;
    min-height: 44px;
    padding-top: 1.6rem;
    padding-bottom: 1.6rem;
    font-family: 'Source Serif 4', serif;
    font-size: 1.6rem;
    line-height: 2.4rem;
    font-weight: 500;
    transition: all 150ms ease;
    cursor: pointer;
    text-align: left;
    border: 0;
    background: transparent;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .lusena-returns-faq__summary:hover {
    color: rgb(14 94 90);
  }

  .lusena-returns-faq__answer {
    padding-top: 0;
    padding-bottom: 1.6rem;
    font-size: 1.4rem;
    line-height: 2rem;
    color: rgb(74 74 74);
    opacity: 1;
    transform: translateY(0);
  }

  /* GPU-composited overlay: opacity+transform run at 120Hz on ProMotion */
  @supports (touch-action: manipulation) {
    .lusena-returns-faq__answer {
      transition: opacity 0.18s ease, transform 0.18s ease;
    }
    .lusena-returns-faq__content[data-state='closed'] .lusena-returns-faq__answer {
      opacity: 0;
      transform: translateY(-6px);
    }
  }

  .lusena-returns-faq__item {
    contain: layout style;
  }

  .lusena-returns-faq__content {
    overflow: hidden;
    height: 0;
    transition: height 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    will-change: height;
  }

  @media (prefers-reduced-motion: reduce) {
    .lusena-returns-faq__content {
      transition: none;
      will-change: auto;
    }
    .lusena-returns-faq__answer {
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }

  .lusena-returns-faq__contact-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 4.8rem;
    padding: 1.2rem 3.2rem;
    border: 1px solid rgb(14 94 90);
    border-radius: 0.6rem;
    background: transparent;
    color: rgb(14 94 90);
    font-size: 1.4rem;
    line-height: 2rem;
    font-weight: 500;
    text-decoration: none;
    transition: background-color 150ms ease, border-color 150ms ease, box-shadow 150ms ease;
  }

  .lusena-returns-faq__contact-button:hover {
    background: rgb(14 94 90 / 0.05);
  }

  .lusena-returns-faq__contact-button:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px rgb(14 94 90 / 0.25);
  }

  @media (min-width: 768px) {
    .lusena-returns-faq {
      padding-top: var(--lusena-section-padding-top-desktop);
      padding-bottom: var(--lusena-section-padding-bottom-desktop);
    }
  }

  .lusena-returns-faq__summary[data-state='open'] .lusena-returns-faq__chevron {
    transform: rotate(180deg);
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    document.querySelectorAll('[data-lusena-returns-faq]').forEach((root) => {
      if (!(root instanceof HTMLElement)) return;
      if (root.dataset.lusenaFaqInit === 'true') return;

      root.dataset.lusenaFaqInit = 'true';
      const prefersReducedMotion = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;

      const getAccordionItemParts = (item) => {
        if (!(item instanceof HTMLElement)) return { trigger: null, content: null };
        return {
          trigger: item.querySelector('[data-lusena-accordion-trigger]'),
          content: item.querySelector('[data-lusena-accordion-content]'),
        };
      };
      const clearAccordionTransition = (content) => {
        if (typeof content._lusenaAccordionOnEnd === 'function') {
          content.removeEventListener('transitionend', content._lusenaAccordionOnEnd);
          content._lusenaAccordionOnEnd = null;
        }
      };

      const setAccordionContentState = (content, isOpen) => {
        if (!(content instanceof HTMLElement)) return;
        const inner = content.firstElementChild instanceof HTMLElement ? content.firstElementChild : content;
        clearAccordionTransition(content);

        if (prefersReducedMotion) {
          content.dataset.state = isOpen ? 'open' : 'closed';
          content.style.height = isOpen ? 'auto' : '0px';
          return;
        }

        if (isOpen) {
          content.style.height = '0px';
          content.dataset.state = 'open';
          const h = inner.scrollHeight;
          requestAnimationFrame(() => {
            content.style.height = h + 'px';
          });
          const onEnd = (e) => {
            if (e.target !== content || e.propertyName !== 'height') return;
            content.removeEventListener('transitionend', onEnd);
            content._lusenaAccordionOnEnd = null;
            content.style.height = 'auto';
          };
          content._lusenaAccordionOnEnd = onEnd;
          content.addEventListener('transitionend', onEnd);
        } else {
          const h = content.offsetHeight;
          content.style.height = h + 'px';
          content.dataset.state = 'closed';
          requestAnimationFrame(() => {
            content.style.height = '0px';
          });
        }
      };

      const setAccordionItemState = (item, isOpen) => {
        if (!(item instanceof HTMLElement)) return;

        const { trigger, content } = getAccordionItemParts(item);
        const state = isOpen ? 'open' : 'closed';

        item.dataset.state = state;

        if (trigger instanceof HTMLElement) {
          trigger.dataset.state = state;
          trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        if (content instanceof HTMLElement) {
          setAccordionContentState(content, isOpen);
        }
      };

      const closeSiblingAccordionItems = (currentItem) => {
        const items = Array.from(root.querySelectorAll('[data-lusena-accordion-item]'));
        items.forEach((item) => {
          if (!(item instanceof HTMLElement) || item === currentItem) return;
          setAccordionItemState(item, false);
        });
      };

      const isSingle = root.hasAttribute('data-lusena-accordion-single');
      const isCollapsible = root.hasAttribute('data-lusena-accordion-collapsible');
      const items = Array.from(root.querySelectorAll('[data-lusena-accordion-item]'));

      const onFastTap = (el, callback) => {
        let startX, startY, handled;
        el.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          handled = false;
        }, { passive: true });
        el.addEventListener('touchend', (e) => {
          const t = e.changedTouches[0];
          if (Math.abs(t.clientX - startX) < 10 && Math.abs(t.clientY - startY) < 10) {
            handled = true;
            e.preventDefault();
            callback(e);
          }
        }, { passive: false });
        el.addEventListener('click', (e) => {
          if (!handled) callback(e);
          handled = false;
        });
      };

      items.forEach((item) => {
        if (!(item instanceof HTMLElement)) return;

        setAccordionItemState(item, false);

        const { trigger } = getAccordionItemParts(item);
        if (!(trigger instanceof HTMLButtonElement)) return;

        onFastTap(trigger, () => {
          const currentlyOpen = item.dataset.state === 'open';

          if (currentlyOpen && isCollapsible) {
            setAccordionItemState(item, false);
            return;
          }

          if (isSingle) {
            closeSiblingAccordionItems(item);
          }

          setAccordionItemState(item, true);
        });
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "LUSENA Returns: FAQ",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (desktop)",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "default": 128
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (desktop)",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "default": 128
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding top (mobile)",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "default": 96
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding bottom (mobile)",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "default": 96
    },
    {
      "type": "text",
      "id": "faq_kicker",
      "label": "FAQ kicker",
      "default": "FAQ"
    },
    {
      "type": "text",
      "id": "faq_heading",
      "label": "FAQ heading",
      "default": "Pytania i odpowiedzi"
    },
    {
      "type": "text",
      "id": "contact_prompt",
      "label": "Contact prompt",
      "default": "Masz inne pytanie?"
    },
    {
      "type": "text",
      "id": "contact_button_label",
      "label": "Contact button label",
      "default": "Skontaktuj się z nami"
    },
    {
      "type": "url",
      "id": "contact_button_link",
      "label": "Contact button link"
    }
  ],
  "blocks": [
    {
      "type": "faq",
      "name": "FAQ item",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "Kto pokrywa koszt wysyłki zwrotnej?"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>W przypadku gwarancji satysfakcji, koszt odesłania produktu leży po stronie klienta. My zwracamy 100% wartości zamówienia (produkt + pierwotna wysyłka).</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "LUSENA Returns: FAQ",
      "blocks": [
        {
          "type": "faq",
          "settings": {
            "question": "Kto pokrywa koszt wysyłki zwrotnej?",
            "answer": "<p>W przypadku gwarancji satysfakcji, koszt odesłania produktu leży po stronie klienta. My zwracamy 100% wartości zamówienia (produkt + pierwotna wysyłka).</p>"
          }
        },
        {
          "type": "faq",
          "settings": {
            "question": "Czy muszę mieć oryginalne pudełko?",
            "answer": "<p>Nie, nie wymagamy oryginalnego pudełka prezentowego, choć ułatwia ono bezpieczny transport. Ważne, aby produkt był zabezpieczony podczas transportu.</p>"
          }
        },
        {
          "type": "faq",
          "settings": {
            "question": "W jakim stanie musi być produkt?",
            "answer": "<p>Akceptujemy produkty używane i prane. Gwarancja nie obejmuje jedynie uszkodzeń mechanicznych powstałych z winy użytkownika.</p>"
          }
        },
        {
          "type": "faq",
          "settings": {
            "question": "Ile czasu mam na decyzję?",
            "answer": "<p>Masz 60 dni kalendarzowych od momentu odebrania paczki. To około 480 godzin snu na podjęcie decyzji.</p>"
          }
        },
        {
          "type": "faq",
          "settings": {
            "question": "Jak wygląda proces po wysłaniu maila?",
            "answer": "<p>Odpowiadamy w ciągu 24 godzin z instrukcją zwrotu. Po odebraniu paczki weryfikujemy produkt i przelewamy środki w ciągu 3-5 dni roboczych.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
