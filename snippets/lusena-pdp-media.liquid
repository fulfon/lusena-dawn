{% doc %}
  PDP media stage + thumbnails.

  @param {product} product
  @param {variant} current_variant
{% enddoc %}

      {%- liquid
        assign initial_media = current_variant.featured_media | default: product.featured_media
        assign initial_preview = initial_media.preview_image | default: initial_media
        assign initial_alt_raw = initial_media.alt | default: initial_preview.alt | default: ''
        assign initial_alt = initial_alt_raw | split: '|' | first | strip
        assign proof_media_id = 'lusena-proof-certificate'
        assign initial_is_zoomable = false
        if initial_media.media_type == 'image'
          assign initial_is_zoomable = true
        endif

        assign is_bestseller = false
        if product.metafields.lusena.badge_bestseller != blank
          if product.metafields.lusena.badge_bestseller.value
            assign is_bestseller = true
          endif
        endif
        if product.tags contains 'lusena:bestseller' or product.tags contains 'bestseller'
          assign is_bestseller = true
        endif

        assign certificate_url = blank
        if shop.metafields.lusena.oeko_tex_certificate != blank
          assign certificate_file = shop.metafields.lusena.oeko_tex_certificate.value
          if certificate_file != blank and certificate_file.url != blank
            assign certificate_url = certificate_file.url
          endif
        endif
      -%}

      <div
        class="md:col-span-7 space-y-3 lusena-gallery{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
        data-lusena-gallery
        {% if certificate_url != blank %}
          data-lusena-proof-id="{{ proof_media_id }}"
        {% endif %}
      >
        <div class="lusena-gallery__desktop" data-lusena-gallery-desktop>
          <div class="lusena-gallery__desktop-grid">
            <div class="lusena-media-thumbs-desktop" data-lusena-media-thumbs-desktop>
              {%- for media in product.media -%}
                {%- liquid
                  assign media_preview = media.preview_image | default: media
                  assign media_alt_raw = media.alt | default: media_preview.alt | default: ''
                  assign media_alt = media_alt_raw | split: '|' | first | strip
                  assign thumb_label = media_alt
                  if thumb_label == blank
                    assign thumb_label = 'Zdjecie ' | append: forloop.index
                  endif
                -%}

                {%- if media_preview != blank -%}
                  <button
                    type="button"
                    class="lusena-media-thumb"
                    data-lusena-thumb
                    data-media-id="{{ media.id }}"
                    aria-label="{{ thumb_label | escape }}"
                  >
                    {{
                      media_preview
                      | image_url: width: 300
                      | image_tag:
                        class: 'w-full h-full object-cover',
                        loading: 'lazy',
                        widths: '120, 180, 240, 300',
                        sizes: '72px',
                        alt: media_alt
                    }}
                  </button>
                {%- endif -%}
              {%- endfor -%}

              {%- if certificate_url != blank -%}
                <button
                  type="button"
                  class="lusena-media-thumb lusena-media-thumb--proof"
                  data-lusena-thumb
                  data-media-id="{{ proof_media_id }}"
                  aria-label="Certyfikat"
                >
                  <span class="lusena-media-thumb__proof-icon">
                    {% render 'lusena-icon', name: 'shield-check', class: 'w-4 h-4', stroke_width: 1.5 %}
                  </span>
                </button>
              {%- endif -%}
            </div>

            <div
              class="lusena-media-stage bg-surface-2 overflow-hidden rounded-sm relative"
              data-lusena-media-stage
              data-stage-type="image"
              data-stage-fade="in"
              data-lusena-stage-action
              data-lusena-stage-zoomable="{{ initial_is_zoomable }}"
              aria-label="Powieksz zdjecie produktu"
              {% if initial_is_zoomable %}
                role="button"
                tabindex="0"
              {% endif %}
            >
              <div class="lusena-media-stage__content" data-lusena-stage-content>
                {%- if initial_preview != blank -%}
                  {{
                    initial_preview
                    | image_url: width: 1600
                    | image_tag:
                      class: 'w-full h-full object-cover',
                      loading: 'eager',
                      fetchpriority: 'high',
                      widths: '600, 800, 1200, 1600',
                      sizes: '(min-width: 750px) 55vw, 100vw',
                      alt: initial_alt
                  }}
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
                {%- endif -%}

                {%- if certificate_url != blank -%}
                  <div class="lusena-proof-tile" data-lusena-stage-proof>
                    <span class="lusena-proof-tile__icon">
                      {% render 'lusena-icon', name: 'shield-check', class: 'w-10 h-10', stroke_width: 1.6 %}
                    </span>
                    <p class="lusena-proof-tile__title">Certyfikat OEKO-TEX</p>
                    <p class="lusena-proof-tile__body">Niezalezny certyfikat bezpieczenstwa tekstyliow.</p>
                    <a
                      href="{{ certificate_url }}"
                      target="_blank"
                      rel="noopener"
                      class="lusena-proof-tile__cta"
                    >
                      Sprawdz certyfikat ->
                    </a>
                  </div>
                {%- endif -%}
              </div>

              {%- if is_bestseller -%}
                <span class="absolute top-4 left-4 bg-white/90 px-3 py-1 text-xs uppercase tracking-wider font-medium backdrop-blur-sm" data-lusena-stage-bestseller hidden>
                  Best Seller
                </span>
              {%- endif -%}

              <span class="lusena-media-stage__zoom" data-lusena-stage-zoom aria-hidden="true">
                {% render 'lusena-icon', name: 'search', class: 'w-4 h-4', stroke_width: 1.8 %}
              </span>
            </div>
          </div>
        </div>

        <div class="lusena-gallery__mobile" data-lusena-gallery-mobile>
          <div class="lusena-gallery__mobile-track" data-lusena-mobile-track>
            {%- for media in product.media -%}
              {%- liquid
                assign media_preview = media.preview_image | default: media
                assign media_alt_raw = media.alt | default: media_preview.alt | default: ''
                assign media_alt = media_alt_raw | split: '|' | first | strip
                assign slide_label = media_alt
                if slide_label == blank
                  assign slide_label = 'Zdjecie ' | append: forloop.index
                endif
              -%}

              {%- if media_preview != blank -%}
                <div
                  class="lusena-gallery__mobile-slide bg-surface-2 overflow-hidden rounded-sm relative"
                  data-lusena-mobile-slide
                  data-media-id="{{ media.id }}"
                  data-media-type="{{ media.media_type }}"
                  {% if media.media_type == 'image' %}
                    data-lusena-mobile-zoomable
                  {% endif %}
                  aria-label="{{ slide_label | escape }}"
                >
                  {%- if forloop.first -%}
                    {{
                      media_preview
                      | image_url: width: 900
                      | image_tag:
                        class: 'w-full h-full object-cover',
                        loading: 'eager',
                        fetchpriority: 'high',
                        widths: '320, 480, 640, 900',
                        sizes: '85vw',
                        alt: media_alt
                    }}
                  {%- else -%}
                    {{
                      media_preview
                      | image_url: width: 900
                      | image_tag:
                        class: 'w-full h-full object-cover',
                        loading: 'lazy',
                        widths: '320, 480, 640, 900',
                        sizes: '85vw',
                        alt: media_alt
                    }}
                  {%- endif -%}
                  {%- if media.media_type == 'image' -%}
                    <span class="lusena-gallery__mobile-zoom" aria-hidden="true">
                      {% render 'lusena-icon', name: 'search', class: 'w-3.5 h-3.5', stroke_width: 1.8 %}
                    </span>
                  {%- endif -%}
                  {%- if is_bestseller and forloop.first -%}
                    <span class="absolute top-3 left-3 bg-white/90 px-2.5 py-1 text-xs uppercase tracking-wider font-medium backdrop-blur-sm" data-lusena-mobile-bestseller hidden>
                      Best Seller
                    </span>
                  {%- endif -%}
                </div>
              {%- endif -%}
            {%- endfor -%}

            {%- if certificate_url != blank -%}
              <div
                class="lusena-gallery__mobile-slide lusena-gallery__mobile-slide--proof"
                data-lusena-mobile-slide
                data-media-id="{{ proof_media_id }}"
                data-media-type="proof"
                aria-label="Certyfikat"
              >
                <div class="lusena-proof-tile">
                  <span class="lusena-proof-tile__icon">
                    {% render 'lusena-icon', name: 'shield-check', class: 'w-10 h-10', stroke_width: 1.6 %}
                  </span>
                  <p class="lusena-proof-tile__title">Certyfikat OEKO-TEX</p>
                  <p class="lusena-proof-tile__body">Niezalezny certyfikat bezpieczenstwa tekstyliow.</p>
                  <a
                    href="{{ certificate_url }}"
                    target="_blank"
                    rel="noopener"
                    class="lusena-proof-tile__cta"
                  >
                    Sprawdz certyfikat ->
                  </a>
                </div>
                {%- if is_bestseller -%}
                  <span class="absolute top-3 left-3 bg-white/90 px-2.5 py-1 text-xs uppercase tracking-wider font-medium backdrop-blur-sm" data-lusena-mobile-bestseller hidden>
                    Best Seller
                  </span>
                {%- endif -%}
              </div>
            {%- endif -%}
          </div>

          <div class="lusena-gallery__mobile-dots" data-lusena-mobile-dots>
            {%- for media in product.media -%}
              <button
                type="button"
                class="lusena-gallery__dot"
                data-lusena-mobile-dot
                data-media-id="{{ media.id }}"
                aria-label="Przejdz do slajdu {{ forloop.index }}"
              ></button>
            {%- endfor -%}
            {%- if certificate_url != blank -%}
              <button
                type="button"
                class="lusena-gallery__dot"
                data-lusena-mobile-dot
                data-media-id="{{ proof_media_id }}"
                aria-label="Przejdz do slajdu certyfikatu"
              ></button>
            {%- endif -%}
          </div>
        </div>

        <div class="lusena-lightbox" data-lusena-lightbox hidden>
          <div class="lusena-lightbox__top">
            <span class="lusena-lightbox__counter" data-lusena-lightbox-counter></span>
            <button type="button" class="lusena-lightbox__close" data-lusena-lightbox-close aria-label="Zamknij podglad">
              {% render 'lusena-icon', name: 'x', class: 'w-6 h-6', stroke_width: 1.8 %}
            </button>
          </div>

          <div class="lusena-lightbox__viewport" data-lusena-lightbox-viewport>
            <button
              type="button"
              class="lusena-lightbox__nav lusena-lightbox__nav--prev"
              data-lusena-lightbox-prev
              aria-label="Poprzednie zdjecie"
            >
              {% render 'lusena-icon', name: 'chevron-right', class: 'w-6 h-6', stroke_width: 1.8 %}
            </button>

            <div class="lusena-lightbox__image-wrap" data-lusena-lightbox-image-wrap>
              <div class="lusena-lightbox__loader" data-lusena-lightbox-loader></div>
              <img
                class="lusena-lightbox__image"
                data-lusena-lightbox-image
                alt=""
                draggable="false"
                width="1200"
                height="1200"
              >
              <div class="lusena-lightbox__fallback" data-lusena-lightbox-fallback hidden>
                Nie udalo sie zaladowac zdjecia
              </div>
            </div>

            <button
              type="button"
              class="lusena-lightbox__nav lusena-lightbox__nav--next"
              data-lusena-lightbox-next
              aria-label="Nastepne zdjecie"
            >
              {% render 'lusena-icon', name: 'chevron-right', class: 'w-6 h-6', stroke_width: 1.8 %}
            </button>
          </div>

          <div class="lusena-lightbox__bottom">
            <span class="lusena-lightbox__hint lusena-lightbox__hint--desktop" data-lusena-lightbox-hint-desktop>
              Kliknij aby powiekszyc
            </span>
            <span class="lusena-lightbox__hint lusena-lightbox__hint--mobile" data-lusena-lightbox-hint-mobile>
              Dotknij dwukrotnie lub rozsun palce
            </span>
          </div>
        </div>
      </div>
